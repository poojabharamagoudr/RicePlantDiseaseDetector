(window.webpackJsonp=window.webpackJsonp||[]).push([[843],{10911:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return E}));var a=n(8),r=n.n(a),i=n(144),o=n.n(i),s=n(238),u=n.n(s),c=n(560),l=n.n(c),d=n(309),p=n(9284),f=n(258),m=n.n(f),g=n(167),v=n(14135),w=n.n(v),h=n(3478),P=g.isMobile?0:20,_=g.isMobile?16:24;var C=function(e){var t=e.userInfo,n=e.position,a=e.visible,r=e.priority,i=t.nickname,c=t.pic,l=t.range,d=t.latesttime,p=Object(s.useRef)({statusClearTimerID:null}).current,f=l.isEditing,v=Object(s.useState)(!1),C=o()(v,2),O=C[0],b=C[1];Object(s.useEffect)((function(){return f&&(b(!0),p.statusClearTimerID&&clearTimeout(p.statusClearTimerID),p.statusClearTimerID=setTimeout((function(){b(!1),clearTimeout(p.statusClearTimerID)}),1500)),function(){clearTimeout(p.statusClearTimerID)}}),[d,f]);var T=function(e,t){if(!e||!e.pos)return null;var n=window.APP,a=e.pos,r=n.data.typoinfo.viewOffset,i=n.data.typoinfo.getLeftInfo(a.layoutIndex),o=n.workspace.config.zoom,s=n.isWebMode()?0:n.workspace.getZoomDiff(),u=Math.ceil(_),c=Math.ceil((e.pos.posY+e.pos.height/2-r.y)*o-u/2),l=Math.ceil(i.outerLeft),d=Math.ceil(i.innerLeft),p=void 0;p=d>2*P+u?l+(d-u)/2:l+d-u-P;var f={left:(p=p*o+s)+"px",top:c+"px",zIndex:t+1};o<1&&(f.transform="scale("+o+")");return f}(n,r);if(!T)return null;var y=Object(h.getNamesStrFromTargets)([t]),E=O?y+_i18n("applications.writer.components.other.editing", "Editing"):y;return u.a.createElement("div",{className:m()("wps-component-avatar-item",{"is-mobile":g.isMobile,"is-editing":O,hidden:!a}),style:T,title:E},u.a.createElement("img",{src:c,alt:i,className:"avatar"}),u.a.createElement("img",{src:w.a,className:"edit-icon",alt:""}))};var O=n(260);var b=function(e){var t=e.userInfo,n=e.position,a=e.priority,r=Object(s.useState)(!1),i=o()(r,2),c=i[0],l=i[1];Object(s.useEffect)((function(){var e=null;function n(n){var a=n.detail,r=a.userID,i=a.duration,o=void 0===i?3500:i,s=a.closeOthers,u=void 0===s||s;r===t.userid?(l(!0),e&&clearTimeout(e),e=setTimeout((function(){l(!1)}),o)):u&&l(!1)}return n({detail:{duration:2e3,userID:t.userid,closeOthers:!1}}),window.addEventListener(O.default.cooperation.SHOW_COOPERATOR_NAME_TIP,n),function(){window.removeEventListener(O.default.cooperation.SHOW_COOPERATOR_NAME_TIP,n),e&&(clearTimeout(e),e=null)}}),[]);var d=window.APP.data.selection.selCoop.getCooperatorColor(t.userid),f=Object(p.getCursorStyle)(n.pos,d,a);if(!f)return null;var g=Object(p.checkIfCursorVisible)(n.pos,parseInt(f.left)),v=Object(h.getNamesStrFromTargets)([t]),w=m()("wps-cooperator-cursor",{"show-nick-name":c,transpose:n.pos.isTranspose,hidden:!g}),P={backgroundColor:d},_=2/devicePixelRatio*Math.round(devicePixelRatio)+"px";n.pos.isTranspose?P.height=_:P.width=_;var C=Object(p.getNameTipStyle)({backgroundColor:d,visible:c});return u.a.createElement("div",{className:w,style:f},u.a.createElement("div",{className:"circle",style:{backgroundColor:d}}),u.a.createElement("div",{className:"cursor",style:P}),u.a.createElement("div",{className:"cooperator-name",style:C},v))},T=n(14136),y=n.n(T);n(14137);function E(e){var t=Object(s.useState)(0),n=o()(t,2)[1],a=Object(s.useState)(0),i=o()(a,2),f=i[0],m=i[1],g=Object(s.useState)(!1),v=o()(g,2),w=v[0],h=v[1],P=Object(s.useRef)({waitingSet:new Set}).current,_=Object(s.useRef)({pages:new Map}).current,O=Object(s.useRef)(null),T=Object(s.useRef)(null),E=Object(s.useCallback)((function(){setTimeout((function(){n(Date.now())}),16)}),[]),A=Object(s.useCallback)(window.utils.Lodash.throttle((function(){E()}),300),[]),S=Object(s.useCallback)((function(e){var t=e&&e.type;if(t===c.DOCCustomEvents.cooperation.COOPERATOR_SELECTION_CHANGE){var n=e.detail,a=n.changedCoopRange,r=n.syncUpdate,i=n.quit;if(a&&"read"===a.permission||!e.detail.changedCoopRange&&!i)return;if(r)return void E()}t===c.DOCCustomEvents.names.DOC_WORKSPACE_AFTER_RESIZE&&(T.current&&clearTimeout(T.current),O.current&&O.current.classList.add("hidden"),T.current=setTimeout((function(){O.current&&O.current.classList.remove("hidden")}),500)),A()}),[]);l()(c.DOCCustomEvents.names.ON_ACTIVE_LINE_CHANGE,(function(e){var t=e.detail.line;t&&m(t.range.begin),h(e.detail.settingEntryVisible)})),l()(c.DOCCustomEvents.names.DOC_WORKSPACE_SCROLL,(function(e){var t=!1;if(_.pages.size>0&&window.APP.data.typoinfo.updater)for(var n=window.APP.data.typoinfo.updater.getCurrentUsedPages(),a=Array.from(_.pages.values()),r=0;r<a.length;r++){var i=a[r],o=window.APP.data.typoinfo.getPageByGcpWithinMaintext(i);if(n.includes(o)){t=!0;break}}(P.waitingSet.size>0||t)&&S()})),l()(c.DOCCustomEvents.names.DOC_WORKSPACE_AFTER_RESIZE,S),l()(c.DOCCustomEvents.cooperation.COOPERATOR_SELECTION_CHANGE,S);var I=function(e){return e.sort((function(e,t){return e.latesttime?t.latesttime?e.latesttime-t.latesttime:-1:1}))}([].concat(r()(window.APP.data.selection.selCoop.coopRanges))).map((function(t,n){if(Object(p.isShowNameTipOnly)(t))return null;var a=t.range,r=t.userid,i=t.nickname;if(!a||a.isInvalid)return null;var o=a.pos,s=window.APP.data.doc.getSubDocType(o);if(s===d.Comment||s===d.HeaderFooter)return null;var c=window.APP.data.typoinfo.getPageByGcpWithinMaintext(o);if(!window.APP.data.typoinfo.updater.getCurrentUsedPages().includes(c))return _.pages.set(r,o),null;_.pages.get(r)&&_.pages.delete(r);var l=Object(p.getAvatarPosition)(a);if(!l)return P.waitingSet.add(r),null;P.waitingSet.delete(r);var m=e.avatarVisible&&(!w||function(e,t){if(!t||!t.pos)return!0;var n=t.pos;return!(!window.APP.isReadOnly()&&n.line.range.begin===e)}(f,l));return u.a.createElement("div",{className:"item","data-name":i,key:r},u.a.createElement(C,{userInfo:t,position:l,visible:m,priority:n}),u.a.createElement(b,{userInfo:t,position:l,priority:n}))})).filter((function(e){return!!e}));return u.a.createElement("div",{className:"wps-cooperators-avatar-and-cursor",ref:O,onClick:function(){return window.APP.focusInput()}},I,u.a.createElement("div",{className:"item show-name-tip-only",key:"name-tip-for-readonly-users"},u.a.createElement(y.a,null)))}},14135:function(e,t,n){e.exports=n.p+"images/editing_icon.5dad924c.svg"},14136:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(5),r=a.__importStar(n(238)),i=a.__importDefault(n(258)),o=a.__importDefault(n(260)),s=n(3478),u=n(9284);t.default=function(){var e=(0,r.useState)(!1),t=e[0],n=e[1],a=(0,r.useState)(),c=a[0],l=a[1],d=(0,r.useState)({userId:-1,nickname:""}),p=d[0],f=d[1];if((0,r.useEffect)((function(){var e=null;function t(t){var a=window.APP.data.selection.selCoop.coopRanges,r=t.detail,i=r.userID,o=r.duration,s=void 0===o?3500:o,c=a.find((function(e){return e.userid===i}));if(c){var d=i===window.APP.info.userid?(0,u.getSelfRange)():c.range;d&&(0,u.isShowNameTipOnly)(c)?(f({userId:i,nickname:c.nickname}),l((0,u.getAvatarPosition)(d)),n(!0),e&&clearTimeout(e),e=setTimeout((function(){n(!1)}),s)):n(!1)}}return window.addEventListener(o.default.cooperation.SHOW_COOPERATOR_NAME_TIP,t),function(){window.removeEventListener(o.default.cooperation.SHOW_COOPERATOR_NAME_TIP,t),e&&(clearTimeout(e),e=null)}}),[]),!c)return null;var m=window.APP.data.selection.selCoop.getCooperatorColor(p.userId),g=(0,u.getCursorStyle)(c.pos,m,99);if(!g)return null;var v=(0,u.checkIfCursorVisible)(c.pos,parseInt(g.left)),w=(0,s.getNamesStrFromTargets)([p]),h=(0,i.default)("wps-cooperator-cursor",{"show-nick-name":t,transpose:c.pos.isTranspose,hidden:!v}),P=(0,u.getNameTipStyle)({backgroundColor:m,visible:t});return r.default.createElement("div",{className:h,style:g},r.default.createElement("div",{className:"cursor",style:{backgroundColor:m}}),r.default.createElement("div",{className:"cooperator-name",style:P},w))}},14137:function(e,t,n){},309:function(e,t,n){"use strict";n.r(t),n.d(t,"MainText",(function(){return a})),n.d(t,"Footnote",(function(){return r})),n.d(t,"HeaderFooter",(function(){return i})),n.d(t,"Macro",(function(){return o})),n.d(t,"Comment",(function(){return s})),n.d(t,"Endnote",(function(){return u})),n.d(t,"Textbox",(function(){return c})),n.d(t,"TextboxInHF",(function(){return l}));var a=0,r=1,i=2,o=3,s=4,u=5,c=6,l=7},3478:function(e,t,n){"use strict";n.r(t),n.d(t,"sortString",(function(){return r})),n.d(t,"getNamesStrFromTargets",(function(){return i})),n.d(t,"parseBase64String",(function(){return o}));var a=n(3854);function r(e){function t(e){var t=e.charCodeAt(0);return t>=0&&t<=128}return e.sort((function(e,n){if(t(e)&&t(n)||!t(e)&&!t(n))return e.localeCompare(n);var a="zh-CN"===window.langName,r=void 0;return r=t(e)?-1:1,a&&(r*=-1),r}))}function i(e){if(!e||!e.length)return"";var t=!1,n=e.map((function(e){return e.nickname?e.nickname.length>a.a.coop_single_name_max_length?(t=!0,e.nickname.substr(0,a.a.coop_single_name_max_length)):e.nickname:""})).join(",");return n.length>a.a.coop_multi_names_max_length&&(n=n.substr(0,a.a.coop_multi_names_max_length)),t&&(n+="..."),n}function o(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={isValid:!1,mimeType:""},a=e.split(",");if(2===a.length){var r=/^data:(?:.*\/.*)?(?:;base64)?/.test(a[0]);n.mimeType=a[0].match(/^data:((?:.*\/[^;]*)?)/)[1];var i=!t||/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$/.test(a[1]);n.isValid=r&&i}return n}},3854:function(e,t,n){"use strict";t.a={coop_single_name_max_length:15,coop_multi_names_max_length:30,coop_avatar_hide_interval:5e3,coop_cursor_hide_tip:2e3,coop_avatar_fadeout_interval:1e3,coop_cursor_tip_fadeout_interval:500,comment_margin_bottom:10,page_num_tip_available_right:30}},9284:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getNameTipStyle=t.getSelfRange=t.checkIfCursorVisible=t.getCursorStyle=t.getAvatarPosition=t.isShowNameTipOnly=void 0;var a=n(167);t.isShowNameTipOnly=function(e){var t=e.userid.startsWith("fake_"),n=e.userid===window.APP.info.userid,a="read"===e.permission;return n||t||a||e.range&&!e.range.isInEditMode},t.getAvatarPosition=function(e){var t=e.pos,n=e.len,a=t+n;if(function(e){try{return window.APP.data.typoinfo.getPosition(e).locate().position!==e}catch(e){return!0}}(a))return null;var r=0!==n||e.glyphTail,i=window.APP.data.doc.datalogics.final.getPapx(a);e.glyphTail&&a>0&&a===i.pos&&window.APP.data.doc.datalogics.final.getPapx(a-1).len>1&&(a-=1,r=!0);var o=window.APP.data.typoinfo.getPosition(a,r).pos;return{pos:{charHeight:o.charHeight,charPosX:o.charPosX,charPosY:o.charPosY,posY:o.posY,posX:o.posX,height:o.height,layoutIndex:o.layoutIndex,isTranspose:o.isTranspose,notInLine:o.notInLine,line:{range:{begin:o.line.range.begin}}}}},t.getCursorStyle=function(e,t,n){var a=window.APP.workspace.waterdrop;if(!a)return null;var r=a.getCursorCoordinates(e);if(!r)return null;var i={top:r.top+"px",left:r.left+"px",zIndex:n+1},o=window.APP.workspace.config.zoom,s=e.charHeight*o,u=5*Math.min(o,1);return e.isTranspose?(i.height=u+"px",i.width=Math.ceil(s)+"px"):(i.height=Math.ceil(s)+"px",i.width=u+"px"),i},t.checkIfCursorVisible=function(e,t){var n=!e.notInLine;return n&&a.isMobile&&e.line.isInTable&&(n=t>window.APP.data.typoinfo.horizontalPadding),n},t.getSelfRange=function(){var e=window.APP.data.selection.getNormalRange();if(0===e.len)try{e.glyphTail=window.APP.data.selection.begin.pos.glyphTail}catch(t){e.glyphTail=!1}return e},t.getNameTipStyle=function(e){return{backgroundColor:e.backgroundColor,display:e.visible?"block":"none"}}}}]);