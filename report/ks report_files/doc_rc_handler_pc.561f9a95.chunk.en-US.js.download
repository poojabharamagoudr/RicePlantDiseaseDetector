(window.webpackJsonp=window.webpackJsonp||[]).push([[879],{10051:function(e,t,n){"use strict";var i=n(80),a=n.n(i),o=n(1),s=n.n(o),r=n(2),d=n.n(r),m=n(13),l=n.n(m),u=n(260),c=n(2939),p=n(3487),h=n(14),f=n(676),v=n(966),g=n(1380),C=n(1146),b=window.rightToLeft?"right":"left",w=function(e){return e.map((function(e){return Object.assign(e.data instanceof Array?function(e){return{data:e.data.map((function(e){return{body:{pos:e.body.pos,len:e.body.len},author:e.author,comment_id:e.comment_id,comment_type:e.comment_type,content:e.content,date:e.date,isTemp:e.isTemp,len:e.len,pos:e.pos,rc_id:e.rc_id,type:e.type,woUserId:e.woUserId,isDone:e.isDone}})),height:e.height,isTemp:e.isTemp,pageIndex:e.pageIndex,position:Object.assign({},e.position),truePos:e.truePos}}(e):function(e){var t={cleanContent:e.cleanContent,wholeContent:e.wholeContent,docType:e.docType,idx:e.idx,rc_id:e.data.rc_id,pageIndex:e.pageIndex,position:e.position,author:e.author,content:e.content,date:e.date,leader:e.leader,revisionType:e.revisionType,user:e.user,userId:e.userID};return"format"===e.type&&(t.cleanContent=Object(g.changeFontNameInText)(t.cleanContent),t.wholeContent=Object(g.changeFontNameInText)(t.wholeContent)),t}(e),{id:e.id,isNew:e.isNew,isJump:e.isJump,isVisible:e.isVisible,preVisible:e.preVisible,type:e.type,range:Object.assign({},e.range)})}))},I=function(){function e(t,n,i,a){s()(this,e),this.workspace=t,this.app=n,this.rchandler=a,this.cooperInfo=c.a,this._element=i.querySelector("cr-list")||Object(f.createElement)({type:"div",style:"position: absolute; top: 0; "+b+": 0; overflow: visible; width: 300px;",parent:i,classname:"cr-list"}),this._comment=null,this.drawComment=this.drawComment.bind(this)}return d()(e,[{key:"bindEvents",value:function(){window.addEventListener(u.default.comments.COMMENTS_PARA_ACTIVE,this.activeCommentPara),window.addEventListener(u.default.comments.COMMENTS_PARA_INACTIVE,this.inactiveCommentPara)}},{key:"unbindEvents",value:function(){window.removeEventListener(u.default.comments.COMMENTS_PARA_ACTIVE,this.activeCommentPara),window.removeEventListener(u.default.comments.COMMENTS_PARA_INACTIVE,this.inactiveCommentPara)}},{key:"clearAll",value:function(){this.lastProps=null,this.unbindEvents(),this.app.frontUtil.ReactDom.unmountComponentAtNode(this._element)}},{key:"drawComment",value:function(){var e=this,t=void 0;if(this.app.isMobileMode()||this.app.isWebMode()){var n=this.app.data.doc.getSubDocRange(0);t=Object(p.d)(this.app.data,n.pos,n.pos+n.len,!this.rchandler.commentVisible,!0)}else{var i=this.workspace.currentUsedPage;t=Object(p.c)(this.app.data,i,!this.rchandler.commentVisible,!0,!1,!1)}var a=t.reduce((function(e,t){if(t.type===v.CR_TYPE.comments){var n=(t.data||[]).filter((function(e){return!Object(C.isRefusalToAppeal)(e.comment_id)})),i=!1;i=t.data&&t.data[0]?Object(C.isRefusalToAppeal)(t.data[0].comment_id):0===n.length;var a=(n||[]).every((function(e){return e.isDone}));e.push(l()({},t.data[0],{id:t.id,isDone:a,isHide:i}))}return e}),[]),o=this.app.commentsDataManager;if(this.app.servicesLoader&&o){var s=this.cooperInfo.coopInfos;a.forEach((function(t){if(t){var n=s.find((function(e){return e.tagid==t.woUserId}));if(n)t.userid=n.userid,t.color=n.color;else if(t.comment_id){var i=o.getCommentCache(t.comment_id);if(i)t.userid=i.user_info.id,t.color=e.cooperInfo.getUserColor(t.userid);else{var a=e.app.commentsDataManager.getUserInfoByCommentId(t.comment_id);a&&(t.userid=a.id,t.color=e.cooperInfo.getUserColor(t.userid))}}}}))}if(this.docUserCommentsHandle.activeAllComment(a),!a.length){var r=window.APP.appApi.getCommentShowStatus();r.commentPanel&&u.default.dispatchEvent(u.default.comments.DRAW_CONTENT_BY_COMMENT,r)}}},{key:"activeCommentPara",value:function(e){var t=e.detail,n=t.range,i=t.comments,a=t.isPara;this.docUserCommentsHandle.activeCommentPara({range:n,comments:i,isPara:a})}},{key:"inactiveCommentPara",value:function(){this.docUserCommentsHandle.inactiveCommentPara(),null===this.rchandler.dataHandler._currItemId&&Object(h.hasQuery)("version")&&u.default.dispatchEvent(u.default.revision.REVISION_ACTIVE_CHANGE,{curId:0,data:this.rchandler.dataHandler.getData()})}},{key:"hoverCommentPara",value:function(e){var t=e.detail,n=t.range,i=t.comments,a=t.isPara;this.docUserCommentsHandle.hoverCommentPara({range:n,comments:i,isPara:a})}},{key:"outCommentPara",value:function(){this.docUserCommentsHandle.outCommentPara()}},{key:"filterData",value:function(e){if(this.app.editor){var t=this.app.editor.viewSettings.revisionMark,n=Object.assign({},e),i=[],a=[],o=[];return e.data.forEach((function(n,s){t.isVisibleForUser(n.author||n.user)&&(i.push(n),a.push(e.tops[s]),o.push(e.ranges[s]))})),n.data=i,n.tops=a,n.ranges=o,n.length=i.length,n}return e}},{key:"render",value:function(e){e.data=w(e.data);var t=this.filterData(e);this._comment=this.app.frontUtil.ReactDom.render(this.app.frontUtil.RevisionComment(t),this._element)}},{key:"dataHandler",get:function(){return this.rchandler.dataHandler}},{key:"comment",get:function(){return this._comment}},{key:"docUserCommentsHandle",get:function(){return this.app.services.userCommentsManager.docUserCommentsHandle}}]),e}(),y=function(){function e(t,n,i,o){var r,d=this;s()(this,e),this.notify=(r=a()(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.detail){e.next=3;break}return e.abrupt("return");case 3:e.t0=n.type,e.next=e.t0===v.NOTIFY_TYPE.deleteText||e.t0===v.NOTIFY_TYPE.insertText||e.t0===v.NOTIFY_TYPE.setProp||e.t0===v.NOTIFY_TYPE.delInsSame?6:e.t0===v.NOTIFY_TYPE.insertComment?8:e.t0===v.NOTIFY_TYPE.removeComment?10:e.t0===v.NOTIFY_TYPE.insertCommentText||e.t0===v.NOTIFY_TYPE.deleteCommentText?12:14;break;case 6:return d.changeText(n),e.abrupt("break",15);case 8:return Promise.resolve().then((function(){d.insertComment(n)})),e.abrupt("break",15);case 10:return d.deleteComment(n),e.abrupt("break",15);case 12:return d.editCommentBody(n),e.abrupt("break",15);case 14:return e.abrupt("break",15);case 15:case"end":return e.stop()}}),e,d)}))),function(e){return r.apply(this,arguments)}),this.changeText=t,this.insertComment=n,this.deleteComment=i,this.editCommentBody=o,this.bindEvents()}return d()(e,[{key:"clearAll",value:function(){this.unbindEvents()}},{key:"bindEvents",value:function(){window.addEventListener(u.default.comments.COMMENTS_PARAS_INVALID,this.notify)}},{key:"unbindEvents",value:function(){window.removeEventListener(u.default.comments.COMMENTS_PARAS_INVALID,this.notify)}}]),e}(),E=n(309),T=function(){function e(t,n,i){s()(this,e),this._commentVisible=!1,this.workspace=t,this.app=n,this.container=i,this.isShowRevisionBtn=!0}var t,n;return d()(e,[{key:"init",value:function(){this.renderHandler=new I(this.workspace,this.app,this.container,this),this.notifyHandler=new y(this.changeText,this.insertComment,this.deleteComment,this.editCommentBody),this.bindEvents();var e=Object(f.getPrefix)();e="webkit"===e?e:"",this.transitionEvent=""===e?"transitionend":e+"TransitionEnd",this.animationEvent=""===e?"animationend":e+"AnimationEnd",this.commentVisible=!0,this.revisionVisible=!0}},{key:"clearAll",value:function(){this.unbindEvents(),this.renderHandler.clearAll(),this.notifyHandler.clearAll()}},{key:"getDocCommentData",value:(n=a()(regeneratorRuntime.mark((function e(t,n){var i,a,o,s,r,d,m=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=this.app.data.doc.getSubDocRange(E.MainText),a=Object(p.b)(this.app.data.doc,i.pos,i.pos+i.len),o=t+n,s=[],r=t-1;r<o;r+=50)d=this.getOnLineData(a.slice(r,r+50),!1),s.push(d);return e.abrupt("return",Promise.all(s).then((function(){return a.slice(t-1,t+n-1).map((function(e){var t=e.comment_id,n="";if(e.userId=void 0,t){var i=m.app.services&&m.app.commentsDataManager,a=i&&i.getCommentCache(e.comment_id);a&&(e.userId=a.user_info.id,n=a.p_comment_id)}return{commentId:t,rcId:e.rc_id,replyCommentId:n,userId:e.userId,author:e.author,content:e.content,date:e.date,pos:e.pos,len:e.len}}))})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"waitTimeout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,t=arguments[1],n=void 0,i=void 0,a=void 0,o=function t(){cancelAnimationFrame(n),performance.now()-i>=e?a&&a():n=requestAnimationFrame(t)};return new Promise((function(e){a=function(){t&&t(),e()},i=performance.now(),n=requestAnimationFrame(o)}))}},{key:"bindEvents",value:function(){}},{key:"unbindEvents",value:function(){}},{key:"insertComment",value:function(){}},{key:"changeText",value:function(){}},{key:"deleteComment",value:function(){}},{key:"editCommentBody",value:function(){}},{key:"updateActiveRevisionAndComment",value:function(){}},{key:"getOnLineData",value:(t=a()(regeneratorRuntime.mark((function e(t){var n=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.app.commentsDataManager.getComments(t).then((function(e){return e.forEach((function(t){t.p_comment_id&&i&&(e.find((function(e){return e.comment_id===t.p_comment_id}))||n.dataHandler.commentIds.push({comment_id:t.p_comment_id}))})),!0}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"docUserCommentsHandle",get:function(){return this.app.services.userCommentsManager.docUserCommentsHandle}},{key:"commentVisible",get:function(){return this._commentVisible&&this.app.isCommentEnabled},set:function(e){this._commentVisible=e}}]),e}();t.a=T},10900:function(e,t,n){"use strict";n.r(t),n.d(t,"DOCRevisionCommentPC",(function(){return Z}));var i=n(13),a=n.n(i),o=n(8),s=n.n(o),r=n(80),d=n.n(r),m=n(1),l=n.n(m),u=n(2),c=n.n(u),p=n(22),h=n.n(p),f=n(145),v=n.n(f),g=n(23),C=n.n(g),b=n(10051),w=n(260),I=n(227),y=n(966),E=n(14),T=n(1285),_=n(3487),M=["client","rollback","closenosave"],R=function(){function e(t,n,i){l()(this,e),this.workspace=t,this.versionType="weboffice",this.app=i,this.historyVersionObj=this.app.workspace.historyVersionObj,this.revisionCount=this.historyVersionObj&&this.historyVersionObj.revisionCount||0,this.compareVersion=this.historyVersionObj&&this.historyVersionObj.compareVersion||0,window.__WPSENV__.cache_preview&&0===this.compareVersion&&(this.compareVersion=1),this.preview=this.historyVersionObj&&this.historyVersionObj.preview||!1,this.version=null,this.allData=null,this.rchandler=n,this.getRevisionCount=this.getRevisionCount.bind(this),this.getContainer=this.getContainer.bind(this),this.init()}var t,n,i,a,o;return c()(e,[{key:"init",value:(o=d()(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.version=this.getVersion(),window.addEventListener(w.default.revision.REVISION_COUNT,this.getRevisionCount),e.next=4,this.getDocData();case 4:this.getVersionType().then((function(){t.start()}));case 5:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"start",value:(a=d()(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.isCompareVersion()||this.preview,n=this.allData.length,t?(window.APP.workspace.revisionComment.versionCompare.showToast(this.versionType,n),window.collection("revision_old")):this.isCompareVersion()||this.preview||(w.default.dispatchEvent(w.default.revision.REVISION_DATA_END,{isShowRevisionPaginator:!0,data:this.allData,compareVersion:this.compareVersion}),(this.revisionCount&&0===this.revisionCount||!this.revisionCount&&0===this.allData.length)&&window.APP.workspace.showToast("warn",_i18n("applications.writer.components.other.historyRevision.nothingChange", "No changes have been made compared with the previous version"),this.getContainer),window.collection("revision_new")),document.querySelector(".component-version-preview")?window.collection("revision_checkOver"):window.collection("revision_check");case 4:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getRevisionCount",value:function(e){this.revisionCount=e.detail.revisionCount,this.compareVersion=e.detail.compareVersion,this.preview=e.detail.preview,window.removeEventListener(w.default.revision.REVISION_COUNT,this.getRevisionCount)}},{key:"getVersionType",value:function(){var e=this;return new Promise((function(t,n){window.__WPSENV__.callAPI({method:"GET",url:"/api/v3/office/file/"+window.urlFileId+"/version/"+e.version}).then((function(n){var i=n.body,a=null;a=i.extra&&i.extra.ver_type?i.extra.ver_type:"client",sessionStorage.setItem("versionType",a),e.versionType=a,t()})).catch((function(){n("promise reject: get version type: request error")}))}))}},{key:"isCompareVersion",value:function(){return!(1!==this.version&&!this.checkVerType(this.versionType))}},{key:"getVersion",value:function(){return parseInt(Object(E.getQuery)("version"))}},{key:"getContainer",value:function(){return this.workspace.element}},{key:"showToast",value:function(e,t){0===t?this.preview?this.workspace.showToast("warn",""+_i18n("applications.writer.components.other.historyRevision.notOnlineVersionCompare", "Non-online version, unable to compare with the previous version"),this.getContainer):"client"===e||"rollback"!==e&&"closenosave"!==e||this.workspace.showToast("warn",""+_i18n("applications.writer.components.other.historyRevision.rollbackVersionCompare", "Restored version, unable to compare with the previous version"),this.getContainer):this.preview?this.workspace.showToast("warn",""+_i18n("applications.writer.components.other.historyRevision.notOnlineVersionShowTip", "Non-online version, unable to compare and show original revision records"),this.getContainer):"client"===e||"rollback"!==e&&"closenosave"!==e||this.workspace.showToast("warn",""+_i18n("applications.writer.components.other.historyRevision.rollbackVersionShowTip", "Restored version, unable to compare and show original revision records"),this.getContainer)}},{key:"checkVerType",value:function(e){return M.indexOf(e)>=0}},{key:"getDocData",value:(i=d()(regeneratorRuntime.mark((function e(){var t,n,i,a,o,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=this.app.data.typoinfo.pageCount||0,n=[],i=[],a=0;a<t;a++)n.push(a);if(!this.app.isWebMode()){e.next=10;break}o=this.app.data.doc.getSubDocRange(0),i=(i=Object(_.d)(this.app.data,o.pos,o.pos+o.len,!1,!1)).sort((function(e,t){return e.range.pos-t.range.pos})),e.next=13;break;case 10:return e.next=12,Object(_.c)(this.app.data,n,!this.rchandler.commentVisible,!this.rchandler.revisionVisible,this.app.isWebMode());case 12:i=e.sent;case 13:return i.map((function(e){e.type!==y.CR_TYPE.comments&&(e.id=e.rc_id,e.range={pos:e.pos,len:e.len,idx:e.pageIndex,docType:e.docType}),e.position||(e.position={top:s.rchandler.dataHandler.getPosByRange(e.range)})})),(null!==this.allData&&this.allData.length<i.length||null===this.allData)&&(this.isCompareVersion()||w.default.dispatchEvent(w.default.revision.REVISION_DATA_CHANGE,{data:i}),this.allData=i),e.abrupt("return",this.allData);case 16:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"handPrevClick",value:(n=d()(regeneratorRuntime.mark((function e(t){var n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.allData,1!==(i=this.getActiveIndex())){e.next=6;break}return e.next=5,this.getDocData();case 5:n=this.allData;case 6:t&&window.collection("commandbar","click","revision_previous"),1!==i&&0!==i||(i=n.length+1),this.activeBubble(n,i-2);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"handNextClick",value:(t=d()(regeneratorRuntime.mark((function e(t){var n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.allData,(i=this.getActiveIndex())!==n.length){e.next=6;break}return e.next=5,this.getDocData();case 5:n=this.allData;case 6:t&&window.collection("commandbar","click","revision_next"),i===n.length&&(i=0),this.activeBubble(n,i);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"activeBubble",value:function(e,t){e[t]&&(void 0!==e[t].idx&&e[t].docType!==y.DOC_TYPE.main&&(this.app.data.selection.selContext.setInHeaderFooterPurely(!0),this.app.data.selection.selContext.setHeaderfooterLayoutIndex(e[t].idx)),this.app.data.selection.setPosition(e[t].range.pos),this.app.workspace.makesureCursorVisible(),this.rchandler.getAllDataDraw(),this.rchandler.update(),e[t].type==y.CR_TYPE.comments?this.rchandler.onActive(e[t].range,e[t].id,e[t]):this.rchandler.onActive(e[t].range,e[t].id,e))}},{key:"makesureCardVisible",value:function(e){var t=!0,n=window.APP.workspace.config.zoom,i=e.position.top*n,a=document.getElementById("workspace");if(i){var o=a.clientHeight,s=a.scrollTop;return(i+47+82<s||i+47+82>s+o)&&(this.workspace.scrollTo({scrollTop:i+47+82}),t=!1),t}}},{key:"getActiveIndex",value:function(){for(var e=this.rchandler.dataHandler.currItemId,t=this.allData,n=0;n<t.length;n++)if(t[n].id===e)return n+1;return 0}}]),e}(),k=n(4806),O=n(309),P=n(1170),B=n(1146),D=function(){function e(t,n,i){var a=this;l()(this,e),this.filterVisibleComments=function(e){return e.reduce((function(e,t){if(t.type===y.CR_TYPE.comments){var n=(t.data||[]).filter((function(e){return!Object(B.isRefusalToAppeal)(e.comment_id)}));(t.data&&t.data[0]?Object(B.isRefusalToAppeal)(t.data[0].comment_id):0===n.length)?delete a.dataIdObj[t.id]:(t.data=n,e.push(t))}else e.push(t);return e}),[])},this.workspace=t,this.app=n,this.rcHandler=i,this.visible=!1,this.data=[],this.dataIdObj={},this._currItemId=null,this.waitInsertData=[],this.isJumpOutofIndex=8,this.hasTempComment=!1,this.tempBubbleId=null,this.tempCommentId=null,this.tempRcId=null,this.tempReplyId=null,this.tempReplyTo=null,this.tempRange=null,this.tempTrueBubbleId=null,this.tempTrueCommentId=null,this.reEditCommentId=null}return c()(e,[{key:"checkIsItemVisible",value:function(e){if(e){if(e.type===y.CR_TYPE.comments)return this.app.isCommentEnabled;var t=this.app.editor;if(t&&!t.viewSettings.revisionMark.isVisibleForUser(e.user||e.author))return!1}return!0}},{key:"getViewData",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=[],i=[],a=[],o=new Set;return this.data=this.data.reduce((function(s,r){return o.has(r.id)||(o.add(r.id),s.push(r),t&&!e.checkIsItemVisible(r)||(n.push(r.position?r.position.top:0),i.push(r.range?{pos:r.range.pos,len:r.range.len,idx:r.range.idx,doctype:r.range.doctype}:null),a.push(r))),s}),[]),t?{data:a,tops:n,ranges:i,length:a.length}:{data:this.data,tops:n,ranges:i,length:this.data.length}}},{key:"getVisibleData",value:function(){var e=this;return this.data.filter((function(t){if(!(t.type===y.CR_TYPE.comments)){var n=e.app.editor;if(n&&!n.viewSettings.revisionMark.isVisibleForUser(t.user||t.author))return!1}return!0}))}},{key:"getData",value:function(){return this.getViewData(!1)}},{key:"handleFillTempBubble",value:function(e,t){var n=this;if(this.tempTrueBubbleId){var i=e.find((function(e){return e.id===n.tempTrueBubbleId}));i?(i.id=this.tempBubbleId,i.data.push(t)):(this.makeAndInsertBubble(e,this.tempRange,t),this.tempTrueBubbleId=null)}else{var a=e.find((function(e){return e.range.pos===n.tempRange.pos&&e.range.len===n.tempRange.len+(e.data.length||0)}));a&&a.type===y.CR_TYPE.comments?(this.tempTrueBubbleId=a.id,a.id=this.tempBubbleId,a.data.push(t)):this.makeAndInsertBubble(e,this.tempRange,t)}}},{key:"handleFillTempComment",value:function(e,t){var n=this;if(this.tempTrueBubbleId)if(this.tempTrueBubbleId===y.TEMP){var i=e.find((function(e){return e.range.pos===n.tempRange.pos&&e.range.len===n.tempRange.len+(e.data.length||0)}));i&&i.type===y.CR_TYPE.comments?(this.tempTrueBubbleId=i.id,i.id=this.tempBubbleId,i.data.push(t)):this.makeAndInsertBubble(e,this.tempRange,t,this.tempBubbleId)}else{var a=e.find((function(e){return e.id===n.tempTrueBubbleId}));a?(a.id=this.tempBubbleId,a.data.push(t)):(this.makeAndInsertBubble(e,this.tempRange,t,this.tempBubbleId),this.tempTrueBubbleId=y.TEMP)}else{var o=e.find((function(e){return e.id===n.tempBubbleId}));o?o.data.push(t):(this.makeAndInsertBubble(e,this.tempRange,t,this.tempBubbleId),this.tempTrueBubbleId=y.TEMP)}}},{key:"fillTemp",value:function(e){if(!this.isReEditingComment&&this.hasTempComment&&this.tempRange){var t=Object(P.getTempCommentData)();Object(P.isTempBubbleId)(this.tempBubbleId)?this.handleFillTempBubble(e,t):Object(P.isTempCommentId)(this.tempCommentId)&&this.handleFillTempComment(e,t)}}},{key:"makeAndInsertBubble",value:function(e,t,n,i){var a=Object(P.getTempBubbleData)(t,n,i),o=e.findIndex((function(e){return e.range.pos>t.pos||e.range.pos===t.pos&&e.range.len>t.len}));o=-1!==o?o:e.length,e.splice(o,0,a)}},{key:"getAllData",value:function(e,t,n){var i=this,a=Object(_.c)(this.app.data,e,t,n,this.app.isWebMode());this.fillTemp(a);var o=this.filterVisibleComments(a),s=this.data.length!==o.length;return this.data=o.map((function(e){return i.BuildSingleData(e)})),s}},{key:"BuildSingleData",value:function(e){var t=this,n=e.type===y.CR_TYPE.comments;n||(e.id=e.rc_id,e.range={pos:e.pos,len:e.len,idx:e.pageIndex,docType:e.docType},e.cleanContent=e.wholeContent.replace(/\n{3,}/g,"\n").replace(/\r{3,}/g,"\r"));var i=this.dataIdObj[e.id];if(i){e.isNew=!1;var a=i.position?i.position.top:this.getPosByRange(e.range),o=this.judgeCardVisible(a+i.height);e.position={top:a},e.height=i.height,e.truePos=i.truePos,e.isVisible=e.preVisible=o}else{var s=this.getPosByRange(e.range);e.isNew=!0,e.position={top:s},e.truePos=s,e.isVisible=e.preVisible=!0,e.height=98}if(n){var r=e.data.find((function(e){return e.comment_id===t.tempCommentId}));r&&(this.currItemId=this.tempBubbleId=e.id,this.tempRcId=r.rc_id,r.isTemp=!0,e.isTemp=!0,this.dataIdObj[y.TEMP]=e)}return this.dataIdObj[e.id]=e,e}},{key:"getStepData",value:function(e,t,n){var i,a=this,o=Object(_.c)(this.app.data,e,t,n,this.app.isWebMode()),r=this.filterVisibleComments(o).map((function(e){return a.BuildSingleData(e)}));(i=this.waitInsertData).push.apply(i,s()(r))}},{key:"clearWaitInsertData",value:function(){this.waitInsertData=[]}},{key:"searchData",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.data.length,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=void 0,o=t;o<n&&void 0===(a=e.call(this,this.data[o],o));o+=i);return a}},{key:"setModalVisibleById",value:function(e){this.currItemId=e}},{key:"ModifyModalByIndex",value:function(e,t,n){var i=this.getVisibleData();if(0===i.length)return!1;var a=this.currItemId||t,o=this.dataIdObj[a];if(!o)return console.log("error currId",a),!1;o.position={top:"point"===e?this.getPosBySelection():this.getPosByRange(o.range)},o.isVisible=!0,o.isJump=!1;var s=i.findIndex((function(e){return e.id===a}));if(-1===s)return!1;for(var r=s-1,d=void 0,m=s+1;m<i.length;m++){d=i[m];var l=i[m-1];this.nextCardFit(d,l,n,s,m)}for(var u=r;u>=0;u--)if(d=i[u]){var c=this.getHeight(d.id);if(c){var p=d.position.top;if(p+c>i[u+1].position.top-20)p=i[u+1].position.top-20-c;else({top:this.getPosByRange(d.range)}).top+c>=i[u+1].position.top-20&&(p=i[u+1].position.top-20-c);d.preVisible=this.judgeCardVisible(d.position.top+d.height),d.isVisible=this.judgeCardVisible(p+d.height,n),d.isJump=!0,d.isVisible||(d.isVisible=this.judgeCardVisible(this.getPos(d.id)+d.height,n)),this.judgeCardPageVisible(p,d.height,n)&&(d.isJump=!1),d.position={top:p}}}}},{key:"nextCardFit",value:function(e,t,n,i,a){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];if(!e)return!1;var s=this.getPosByRange(e.range),r=o?s:e.position.top,d=r;if(t){var m=this.getHeight(t.id);if(m){var l=m+t.position.top+20;r<l&&(r=l)}}e.preVisible=this.judgeCardVisible(d+e.height),e.isVisible=this.judgeCardVisible(r+e.height,n),e.isJump=!0,e.isVisible||(e.isVisible=this.judgeCardVisible(this.getPos(e.id)+e.height,n)),void 0!==i&&this.judgeCardPageVisible(r,e.height,n)&&(e.isJump=!1),e.position={top:r}}},{key:"ModifyModalToFit",value:function(){var e=this;this.getVisibleData().forEach((function(t,n,i){var a=t,o=i[n-1];e.nextCardFit(a,o)}))}},{key:"ModifyOtherModalToFit",value:function(){var e=this.getVisibleData();if(0===e.length||1===e.length)return!1;for(var t=1;t<this.data.length;t++){var n=e[t],i=e[t-1];this.nextCardFit(n,i,null,null,null,!1)}}},{key:"ModifyModalToFitPart",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=-1,a=void 0;if(t){i=this.deleteCommentGroupById(e,null,n);var o=this.data[i];i=o?(a=this.getVisibleData()).findIndex((function(e){return e.id===o.id})):-1}else i=(a=this.getVisibleData()).findIndex((function(t){return t.id===e}));if(-1===i)return!1;for(var s=i;s<a.length;s++){var r=a[s],d=a[s-1];this.nextCardFit(r,d,null,i,s)}}},{key:"onFocusBlur",value:function(e){this.ModifyModalByIndex(null,e)}},{key:"getCurrentCommentRange",value:function(){if(!this.currItemId)return!1;var e=this.app.data.doc.commentBubbles.getBubbleById(this.currItemId);return!!e&&{pos:e.pos,len:e.len}}},{key:"onSelectionChanged",value:function(){if(this.hasTempComment&&this.tempRange)if(Object(P.isTempBubbleId)(this.tempBubbleId)){var e=this.app.data.selection.getNormalRange();if(0===e.len)this.delTempComment();else{var t=this.tempRange;e.pos===t.pos&&e.len===t.len||(this.tempRange=e)}}else if(Object(P.isTempCommentId)(this.tempCommentId)){var n=this.app.data.doc.commentBubbles.getBubbleById(this.tempBubbleId);if(n){var i=this.tempRange;n.pos===i.pos&&n.len===i.len||(this.tempRange={pos:n.pos,len:n.len})}else{var a=this.app.data.selection.getNormalRange();if(0===a.len)this.delTempComment();else{var o=this.tempRange;a.pos===o.pos&&a.len===o.len||(this.tempRange=a)}}}}},{key:"delTempComment",value:function(){this.app.uilManager.exitCommentBody(),this.resetTempCommentBubble(),this.setModalVisibleById(),this.rcHandler.doModalToFit()}},{key:"setTempCommentBubble",value:function(e){var t=e.bubbleId,n=e.commentId,i=e.rcId,a=e.replyId,o=e.isNotifyTempComment,s=e.range;this.hasTempComment=!0,this.tempBubbleId=t,this.tempCommentId=n,this.tempRcId=i,this.tempReplyId=a,this.tempRange=s,this.isNotifyTempComment=o}},{key:"setEditingCommentId",value:function(e){this.reEditCommentId=e}},{key:"resetTempCommentBubble",value:function(){var e=this,t=this.data.find((function(t){return t.id===e.tempBubbleId}));if(t){this.tempBubbleId===y.TEMP&&this.data.splice(this.data.findIndex((function(t){return t.id===e.tempBubbleId})),1),t.isTemp=!1;var n=t.data.find((function(t){return t.comment_id===e.tempCommentId}));n&&(this.tempCommentId===y.TEMP&&t.data.splice(t.data.findIndex((function(t){return t.comment_id===e.tempCommentId})),1),n.isTemp=!1)}this.dataIdObj[y.TEMP]=null,this.hasTempComment=!1,this.isNotifyTempComment=!1,this.tempBubbleId=null,this.tempCommentId=null,this.tempRcId=null,this.tempReplyId=null,this.tempReplyTo=null,this.tempRange=null,this.tempTrueBubbleId=null,this.tempTrueCommentId=null,this.reEditCommentId=null}},{key:"isCurrItemExist",value:function(){if(this.currItemId&&(this.findCommentGroupById(this.currItemId)>=0&&this.dataIdObj[this.currItemId]&&document.getElementsByClassName("cr_modal_"+this.currItemId)))return!0;return!1}},{key:"findCommentGroupById",value:function(e){return this.searchData((function(t,n){if(t.id===e)return n}))}},{key:"deleteCommentGroupById",value:function(e,t){var n=t;return n||(n=this.findCommentGroupById(e)),void 0!==n&&(this.data.splice(n,1),this.currItemId===e&&(this.currItemId=null,delete this.dataIdObj[e])),n}},{key:"deleteComment",value:function(e){if(e&&e.data&&e.data.length>0){var t=this.dataIdObj[e.id];t.range=e.range,t.data=e.data}else this.deleteCommentGroupById(this.currItemId)}},{key:"judgeCardVisible",value:function(e,t){var n=void 0===t?this.rcHandler.scrollTop:t,i=this.rcHandler.height;return e>n-i/2&&e<n+3*i/2}},{key:"judgeCardPageVisible",value:function(e,t,n){var i=void 0===n?this.rcHandler.scrollTop:n,a=this.rcHandler.height;return e+t>i&&e<i+a}},{key:"setCardVisible",value:function(){var e=this;this.getVisibleData().forEach((function(t){if(t.id!==y.TEMP){var n=t.isVisible;t.isVisible=e.judgeCardVisible(t.position.top+t.height),t.preVisible=void 0!==n?n:t.isVisible,t.isJump=!0,!0===t.preVisible&&!0===t.isVisible&&(t.isJump=!1),t.isVisible||(t.isVisible=e.judgeCardVisible(e.getPos(t.id)+t.height))}}))}},{key:"getPosByRange",value:function(e){if(e&&void 0!==e.pos){var t=a()({},e);if(this.app.data.doc.getSubDocType(t.pos)===O.Comment){var n=this.app.data.doc.commentBodys.getCommentByPos(t.pos);n&&(t.pos=n.pos,t.len=n.len)}var i=this.app.workspace.config.zoom,o=this.app.data.selection.selContext.isInHeaderFooter,s=this.app.data.selection.selContext.headerfooterLayoutIndex;void 0!==t.idx&&t.docType!==y.DOC_TYPE.main&&(this.app.data.selection.selContext.setInHeaderFooterPurely(!0),this.app.data.selection.selContext.setHeaderfooterLayoutIndex(t.idx));var r=T.b.locate(this.app.data,t.pos,null,this.app.data.typoinfo,"line");return this.app.data.selection.selContext.setInHeaderFooterPurely(o),this.app.data.selection.selContext.setHeaderfooterLayoutIndex(s),r&&r.posY?r.posY*i:(console.log("locate failure"),0)}console.log("error range")}},{key:"getPosBySelection",value:function(){var e=this.app.data,t=e.selection,n=e.typoinfo,i=this.app.workspace.config.zoom,a=void 0;if(t.selContext.isInComment())if(this.hasTempComment)this.tempRange&&(a=n.getPosition(this.tempRange.pos).pos);else{var o=t.getNormalRange(),s=this.app.data.doc.commentBodys.getCommentByPos(o.pos);if(s)a=n.getPosition(s.pos).pos;else{var r=this.app.data.doc.getSubDocRange(0).len;o.pos<=r&&(a=n.getPosition(o.pos).pos)}}else{var d=t.selInfo.getTableMultipleSelectLastLinePos();a=t.begin.pos,d?a=n.getPosition(d.pos).pos:t.begin.position>t.end.position&&(a=t.end.pos)}return a&&a.posY?a.posY*i:(console.log("locate failure"),0)}},{key:"getRevisionAndCommentData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.includeRevision,i=void 0===n||n,a=t.includeComment,o=void 0===a||a,s=i?Object(k.b)(this.app.data,e.pos,0):[];s=s.filter(this.checkIsItemVisible.bind(this));var r=o?this.app.data.doc.commentBubbles.getBubbleByRange(e.pos,e.len):null;if(s.length>0){var d=!r||s.some((function(e){var t=e.range;return t.pos>r.range.pos&&t.pos+t.len<r.range.pos+r.range.len}));if(d)return{type:y.CR_TYPE.revision,range:e,data:s}}if(o){if(r){var m=this.app.data.doc.commentBubbles.getBubblesByRange(e.pos,e.len);if(m&&m.length>0){var l=m.filter((function(e){if(e.type===y.CR_TYPE.comments){var t=(e&&e.data||[]).filter((function(e){return!Object(B.isRefusalToAppeal)(e.comment_id)}));return!(e.data&&e.data[0]?Object(B.isRefusalToAppeal)(e.data[0].comment_id):0===t.length)}return!0}));l.length>=0&&(r=l[0])}}return r}return null}},{key:"getLeft",value:function(){var e=(this.app.data.typoinfo.outer_rects||[]).map((function(e){return e.left+e.width})),t=Math.max.apply(Math,s()(e)),n=this.app.workspace.getZoomDiff();return t*this.workspace.config.zoom+n+10}},{key:"setLeft",value:function(){var e=document.querySelector(".cr-list");if(e){var t=void 0,n=void 0,i=this.app.workspace;if(this.app.isWebMode()){t=(this.app.data.typoinfo.viewOffset.x+this.app.data.typoinfo.width)*this.workspace.config.zoom+this.app.workspace.getZoomDiff()+10}else{var a=this.app.data.typoinfo.outer_rects;if(window.rightToLeft){var o=a.map((function(e){return e.left}));n=Math.min.apply(Math,s()(o));var r=i.getZoomDiff();t=n*i.config.zoom+r-10-e.clientWidth}else{var d=a.map((function(e){return e.left+e.width}));n=Math.max.apply(Math,s()(d));var m=i.getZoomDiff();t=n*i.config.zoom+m+10}}e.style.left=t+"px"}}},{key:"getHeightByElement",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=document.querySelector(".cr_modal_"+e);return n?n.offsetHeight:t}},{key:"getHeight",value:function(e){var t=this.dataIdObj[e];return this.checkIsItemVisible(t)?t?t.type!==y.CR_TYPE.comments||t.isHeightValid?t.height:this.getHeightByElement(e,t.height):this.getHeightByElement(e):0}},{key:"getPos",value:function(e){var t=this.dataIdObj[e];if(t)return t.truePos;var n=document.querySelector(".cr_modal_"+e);return parseInt(n.style.top)+parseInt(n.style.transform.match(/,\W?(\d+)/)[1])}},{key:"currItemId",get:function(){return this._currItemId},set:function(e){this._currItemId=e}},{key:"isReEditingComment",get:function(){return this.reEditCommentId&&this.reEditCommentId===this.tempCommentId}}]),e}(),x=n(30),N=n.n(x),S=n(676),H=n(167),A=n(805),L=n(4721),V=n(564),j=window.rightToLeft?"right":"left",F=function(){function e(t,n,i){var a=this;l()(this,e),this.onEnterComment=function(){a.update()},this.onExitComment=function(){a.update()},this.workspace=t,this.app=n,this.visible=!1,this.container=i,this.showCommentsTip=this.showCommentsTip.bind(this),this.openCommentsByBtn=this.openCommentsByBtn.bind(this),this.doNormalOpenDialog=this.doNormalOpenDialog.bind(this),this.setInRestrictEditMode=this.setInRestrictEditMode.bind(this),this.update=this.update.bind(this),this.bindEvents(),this._element=Object(S.createElement)({type:"div",style:"position: absolute; top: 0; "+j+": 0; overflow: visible;",parent:this.container,classname:"comments-wrap"}),this.update()}return c()(e,[{key:"clearAll",value:function(){this.unbindEvents(),window.APP.frontUtil.ReactDom.unmountComponentAtNode(this._element)}},{key:"bindEvents",value:function(){window.addEventListener(w.default.names.DOC_SELECTION_CHANGED,this.update),window.addEventListener(w.default.names.DOC_WORKSPACE_AFTER_RESIZE,this.update),window.addEventListener(w.default.comments.ON_ENTER_COMMENT_BODY,this.onEnterComment),window.addEventListener(w.default.comments.ON_EXIT_COMMENT_BODY,this.onExitComment),window.addEventListener(w.default.comments.SHOW_COMMENTS_TIPS,this.showCommentsTip),window.addEventListener(w.default.comments.OPEN_COMMENTS_DIALOG_BY_BTN,this.openCommentsByBtn),window.addEventListener(w.default.comments.OPEN_COMMENTS_DIALOG,this.doNormalOpenDialog),window.addEventListener(w.default.restrictEdit.ON_RESTRICT_STATE_CHANGE,this.setInRestrictEditMode)}},{key:"unbindEvents",value:function(){window.removeEventListener(w.default.names.DOC_SELECTION_CHANGED,this.update),window.removeEventListener(w.default.comments.ON_ENTER_COMMENT_BODY,this.onEnterComment),window.removeEventListener(w.default.comments.ON_EXIT_COMMENT_BODY,this.onExitComment),window.removeEventListener(w.default.names.DOC_WORKSPACE_AFTER_RESIZE,this.update),window.removeEventListener(w.default.comments.SHOW_COMMENTS_TIPS,this.showCommentsTip),window.removeEventListener(w.default.comments.OPEN_COMMENTS_DIALOG_BY_BTN,this.openCommentsByBtn),window.removeEventListener(w.default.comments.OPEN_COMMENTS_DIALOG,this.doNormalOpenDialog),window.removeEventListener(w.default.restrictEdit.ON_RESTRICT_STATE_CHANGE,this.setInRestrictEditMode)}},{key:"setInRestrictEditMode",value:function(e){this.update()}},{key:"showCommentsTip",value:function(e){this.visible=e.detail.checked,this.update()}},{key:"getRangePos",value:function(e){var t=e.posY+(e.height-20)/2,n=e.layoutIndex;if(this.app.isWebMode()){var i=this.app.data.typoinfo;return{left:i.width-i.horizontalPadding/2-10,top:t-=i.viewOffset.y}}var a=this.app.data.typoinfo.getLayoutPageCache(n);if(a){var o=a.inner_rect,s=a.outer_rect;return s.right-s.left-o.right<20?{left:s.left+o.right+20,top:t}:{left:(s.right-(o.right+s.left))/2+(o.right+s.left)-10||s.left+o.right+20,top:t}}return null}},{key:"openCommentsByBtn",value:function(){this.openDialog()}},{key:"doNormalOpenDialog",value:function(){this.openDialog()}},{key:"openDialog",value:function(){if(Object(V.isReadingMode)())return Object(V.closeReadingMode)(),!1;this.app.functionStatus.comment.disabled||Object(L.checkHasCommentPermission)().then((function(){H.isIPad&&Object(A.focusOnOtherInput)();var e=window.APP.appApi.getCommentShowStatus(),t=e.commentPanel,n=e.commentBubble;t?w.default.dispatchEvent(w.default.comments.GO_TO_ALL_COMMENT_PANEL):n||(window.APP.appApi.showComments({checked:!0}),window.APP.appApi.setCommentShowStatus({commentBubble:!0})),w.default.dispatchEvent(w.default.comments.ON_ADD_ITEM_BY_BTN)})).catch(L.goToApplyForPermission)}},{key:"resize",value:function(){this.update()}},{key:"update",value:function(){window.APP.functionStatus.comment.updateMainTextEntryStatus();var e={visible:this.visible,addParams:this.buildParams()};this.render(e)}},{key:"isSelectionAllBreak",value:function(e){for(var t=e||this.app.data.selection.getNormalRange(),n=t.pos,i=t.len,a=!0,o=n;o<n+i;o++)if(!this.docUserCommentsHandle.isCharBreak(o)){a=!1;break}return a}},{key:"buildParams",value:function(){var e=this.app.data,t=e.selection,n=e.typoinfo,i=t.getNormalRange(),a=i.pos,o=i.len,s=t.begin.pos;if(this.app.data.doc.getSubDocType(a)!==O.MainText)s=null;else{var r=t.selInfo&&t.selInfo.getTableMultipleSelectLastLinePos();r?s=n.getPosition(r.pos).pos:t.begin.position>t.end.position&&(s=t.end.pos)}var d={addPos:this.getAddPos(s),btnVisible:this.app.functionStatus.comment.entryButtonInMainText.visible};return o>0&&(d.beTop=!0),d}},{key:"updateAddPos",value:function(){this.update()}},{key:"getAddPos",value:function(e){if(!e)return{top:-100,left:-100};var t=this.getRangePos(e);if(t){var n=t.left,i=t.top;return N()({top:Math.round(i)},j,Math.round(n))}return{top:-100,left:-100}}},{key:"render",value:function(e){var t=JSON.stringify(e);this._preProps&&this._preProps===t||(this._preProps=t,window.APP.frontUtil.ReactDom.render(window.APP.frontUtil.CommentsTip(e),this._element))}},{key:"docUserCommentsHandle",get:function(){return this.app.services.userCommentsManager.docUserCommentsHandle}}]),e}(),U=n(2183),Y=n(12967),G=n.n(Y),W=n(2295),z=n(1290),q=n(3488),J=n.n(q),Q=n(1131),Z=function(e){function t(e,n,i,a){var o=this;l()(this,t);var r,m,u,c,p,f,v,g,C,b,I,E,T,_=h()(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i));return _.updateCommentStatus=function(){_.getAllDataDraw(),_.update()},_.onCommentShowStatusUpdate=function(e){var t=e.detail.commentPanel;_.revisionVisibleStatus=!t&&_.isRevisionVisible,t?_.unbindDynamicEvents():_.bindDynamicEvents()},_.handleRestrictEditModeChange=function(e){e.detail.isRestrict&&_.dataHandler.hasTempComment&&_.commitTempComment({callback:function(e){e||_.discardTempComment({isResetElements:!0,isUpdatePosition:!0,isResetContext:!0})}})},_.revisionAcceptRefuse=function(e){var t=e.detail,n=t.id,i=t.type;if(n){var a=_.app.data.doc.revisions.getRevisionById(n);a&&a[i]&&a[i](),_.dataHandler.ModifyModalToFitPart(n,!0)}_.update()},_.activeCommentByRange=function(e){var t=e.detail,n=t.range,i=t.type;if(n)if("bookmark"!==i){var a=_.app.data.doc.commentBubbles.getBubbleByRange(n.pos,n.len);if(a){var o=void 0,s=void 0;a.range?(o=a.range.pos,s=a.range.len):(o=a.pos,s=a.len),_.onActive({pos:o,len:s},a.id,a)}}else _.openModalByRange(n)},_.inactiveComment=function(){_.onClose(!1)},_.openModalByRange=function(e){if(_.isCommentBubbleStatus){if(_.selectionCache&&void 0!==_.selectionCache.pos&&void 0!==_.selectionCache.len&&_.selectionCache.pos===e.pos&&_.selectionCache.len===e.len)return!1;var t=_.dataHandler.getRevisionAndCommentData(e,{includeRevision:_.isRevisionVisible,includeComment:_.app.commentShowStatus.commentBubble&&_.app.isCommentEnabled});if(!t||0===t.data.length)return _.dataHandler.currItemId&&_.onClose(!0),!1;var n=t.type===y.CR_TYPE.revision,i=t.type===y.CR_TYPE.comments;t=n?t.data[t.data.length-1]:t;var a=i?t.id:t.rc_id;return a&&!_.dataHandler.dataIdObj[a]&&_.dataHandler.BuildSingleData(t),(t=_.dataHandler.dataIdObj[a])&&(_.dataHandler.data.find((function(e){return e.id===t.id}))||(_.dataHandler.data.unshift(t),_.dataHandler.setModalVisibleById(null)),_.selectionCache=e,_.activeRender({range:t.range,id:t.id,focus:!1,data:t,cb:null,type:"point"})),window.collection("commandbar","click","comment_card_textarea"),!0}},_.insertTempComment=(r=d()(regeneratorRuntime.mark((function e(){var t,n,i,a,s,r,d,m,l,u,c,p,h,f=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!_.isMakingComment){e.next=2;break}return e.abrupt("return",!1);case 2:return _.isMakingComment=!0,t=_.app.data,n=t.selection,i=t.doc,(a=f.range)||(n.selContext.isInComment()?(a=_.dataHandler.getCurrentCommentRange(),_.app.uilManager.exitCommentBody()):f.bubbleId?(s=i.commentBubbles.getBubbleById(f.bubbleId),a={pos:s.pos,len:s.len}):(f.replyId&&(r=i.comments.getCommentByCommentId(f.replyId))&&(a={pos:r.pos,len:r.len}),a||(a=n.getNormalRange(),(d=_.app.data.doc.commentBubbles.getBubbleByRange(a.pos,a.len))&&d.data&&d.data.length>0&&(a=d.range),0!==a.len&&_.docUserCommentsHandle.isLineBreak(a.pos+a.len-1)&&a.len--))),m=_.app.data.doc.commentBubbles.getBubbleByRange(a.pos,a.len),_.dataHandler.tempCommentId=y.TEMP,l=!1,u=y.TEMP,c=y.TEMP,p=y.TEMP,m&&_.commentVisible&&(h=_.app.data.doc.commentBubbles.getBubbleById(m.id))&&(u=h.id,a.pos=h.pos,a.len=h.len),_.dataHandler.setTempCommentBubble({bubbleId:u,rcId:c,replyId:f.replyId,range:a,commentId:p,isNotifyTempComment:!0}),w.default.dispatchEvent(w.default.comments.ON_INSERT_TEMP_COMMENT),_.getAllDataDraw(),_.setActive(a,u,!0,null,null,!1,!0),l=!0,_.isMakingComment=!1,e.abrupt("return",l);case 20:case"end":return e.stop()}}),e,o)}))),function(){return r.apply(this,arguments)}),_.commitAndInsertNewTempComment=function(){return _.commitTempComment({resetNow:!1,callback:function(e){_.app.editor.closeLastTransact(),H.isIPad&&Object(A.focusOnOtherInput)();var t=_.app.data.doc.commentBubbles.getBubbleByRange(e.pos,e.len);t&&_.openCommentsModalByRange({pos:t.range.pos,len:t.range.len})}}),!0},_.insertCommentMethod=function(e,t){var n=void 0;switch(e){case"Emoji":n=_.insertEmojiComment.bind(_,t.detail);break;case"Modal":default:n=_.openCommentsModalByRange.bind(_)}if(n){var i=_.docUserCommentsHandle.getCommentRange(),a=_.app.data.selection;if(a.begin.position!==a.end.position)n(i);else{var o=a.end.pos,s=o.posX,r=o.posY,d=_.app.uilManager.hit({pos:{x:s+1,y:r+1}}),m=!1;if(d.catalogInfos)return void n(i);var l=!1;if(d&&d.position<d.line.range.end-1){try{l=d.ctrlInfos[0].isDate}catch(e){}l||(m=a.selAlter.extendSelectBlock(d,(function(e){e&&(_.adjustCommentRange(),i=_.docUserCommentsHandle.getCommentRange(),n(i))})))}if(!1===m){if(a.begin.position===a.begin.pos.line.range.begin&&l)return void window.Toast.info(_i18n("applications.writer.components.other.Comment.unableToInsertCommentHere", "You are not allowed to insert comments here."));d=_.app.uilManager.hit({pos:{x:s-1,y:r+1}});var u=!1;try{u=d.ctrlInfos[0].isDate}catch(e){}u?window.Toast.info(_i18n("applications.writer.components.other.Comment.unableToInsertCommentHere", "You are not allowed to insert comments here.")):a.selAlter.extendSelectBlock(d,(function(){_.adjustCommentRange(),i=_.docUserCommentsHandle.getCommentRange(),n(i)}))}}}},_.openCommentsModal=function(e){_.insertCommentMethod("Modal",e)},_.insertCommentByEmoji=function(e){_.insertCommentMethod("Emoji",e)},_.insertEmojiComment=(m=d()(regeneratorRuntime.mark((function e(t,n){var i,a,s,r,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.emoji_id,!(a=i&&Object(Q.getEmojiById)(i))){e.next=7;break}return e.next=5,_.app.servicesLoader.commentsDataManager.addComment(n,a.unicode,null,!0,!1);case 5:(s=e.sent)&&(_.app.commentShowStatus.commentPanel&&_.app.viewUIL.typoUpdate(),r=s.range,(d=_.app.data.doc.commentBubbles.getBubbleByRange(r.pos,r.len))&&(_.app.commentShowStatus.commentBubble?_.setActive(null,d.id,!1):_.app.commentShowStatus.commentPanel&&w.default.dispatchEvent(w.default.comments.ACTIVE_COMMENT_PANEL_BUBBLE,{id:d.id,goFirst:!0})));case 7:case"end":return e.stop()}}),e,o)}))),function(e,t){return m.apply(this,arguments)}),_.mentionInComment=(u=d()(regeneratorRuntime.mark((function e(t){var n,i,a,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.detail,i=n.rcId,a=n.bubbleId){e.next=3;break}return e.abrupt("return",!1);case 3:if(s=_.app.data.doc.commentBubbles.getBubbleById(a),i){e.next=9;break}return e.next=7,_.insertTempComment({range:{pos:s.pos,len:s.len}});case 7:return e.next=9,_.waitTimeout(100);case 9:w.default.dispatchEvent(w.default.comments.ON_CLICK_OPEN_AT);case 10:case"end":return e.stop()}}),e,o)}))),function(e){return u.apply(this,arguments)}),_.showRevisionBubble=function(e){var t=e.detail.visible;_.revisionVisibleStatus=t&&_.isRevisionVisible,_.getAllData(),_.revisionVisibleStatus?_.setModalPos():_.doModalToFit()},_.showRevisionHandle=function(e){!0!==e&&_.revisionVisibleStatus===_.isRevisionVisible||(_.revisionVisibleStatus=_.isRevisionVisible,_.getCurrentData(),_.isRevisionVisible?_.setModalPos():_.doModalToFit())},_.showCommentsHandle=function(e){var t=e.detail,n=t.checked,i=t.isTemplate;i&&_.templateShowTime>0||(i&&_.templateShowTime++,_.commentVisible=!!n,_.getAllDataDraw(),_.commentVisible?_.dataHandler.hasTempComment?_.doModalByIndex("point",{},_.dataHandler.tempBubbleId):_.setModalPos():_.doModalToFit())},_.diffPages=function(e){var t=_.app.workspace.config.zoom,n=e;"[object Array]"===window.utils.Lodash.getType(e)&&0!==e.length||(n=[].concat(s()(_.app.workspace.currentUsedPage)));try{if(t!==_.zoom)return!0;if(n.length!==_.usedPage.length)return!0;for(var i=0;i<n.length;i++)if(n[i]!==_.usedPage[i])return!0;return!1}finally{_.usedPage=n,_.zoom=t}},_.beforeViewModeChanged=function(e){_.dataHandler.hasTempComment&&_.discardTempComment({isUpdatePosition:!0,isResetElements:!0})},_.onExitComment=function(e){_.dataHandler.hasTempComment&&_.commitTempComment({isUpdatePosition:!1,resetNow:!0,callback:function(t){t||_.discardTempComment(e.detail)}})},_.onBeforeUnload=function(){_.dataHandler.hasTempComment&&_.discardTempComment({isResetContext:!0,isUpdatePosition:!0,isResetElements:!0})},_.handleUndoRedo=function(e){var t=_.app.data.selection;switch(!0){case t.selContext.isInComment()&&!_.dataHandler.hasTempComment:_.restoreTempComment();break;case t.selContext.isInComment()&&_.dataHandler.hasTempComment:_.switchTempComment();break;case!t.selContext.isInComment()&&_.dataHandler.hasTempComment:_.discardTempComment({isResetElements:!0})}},_.viewportChange=function(){!_.workspace.unMount&&_.isCommentBubbleStatus&&(_.update(),_.workspace.resizeIfNecessary(),_.dataHandler.hasTempComment&&_.workspace.updateCommentIndicator())},_.getCurPages=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_.workspace.currentUsedPage,t=[].concat(s()(e)),n=Math.min.apply(Math,s()(t));1===t.length&&n>0&&t.unshift(n-1);var i=_.dataHandler.dataIdObj[_.dataHandler.currItemId];return i&&i.pageIndex&&!t.includes(i.pageIndex)&&(t.push(i.pageIndex),t.sort((function(e,t){return e-t}))),t},_.getCurrentData=function(){var e=_.getCurPages(),t=_.dataHandler.getAllData(e,!_.commentVisible,!_.revisionVisibleStatus);return _.app.appApi.getCommentShowStatus().commentBubble&&_.backfillCurr(e),t},_.getScrollData=function(){var e=_.getCurPages(_.usedPage);_.dataHandler.getAllData(e,!_.commentVisible,!_.revisionVisibleStatus),_.app.appApi.getCommentShowStatus().commentBubble&&_.backfillCurr(e),_.update(),_.doModelToScroll()},_.getAllData=function(){return _.getCurrentData()},_.getNextData=function(){if(!(_.usedPageMax<=_.allUsedPageMax)){for(var e=Math.max(_.usedPageMax,_.allUsedPageMax),t=[],n=_.allUsedPageMax+1;n<=e;n++)t.push(n);t.length>0&&(_.allUsedPageMax=e,_.dataHandler.getStepData(t,!_.commentVisible,!_.revisionVisibleStatus),_.doInsertData())}},_.doInsertData=function(){var e=_.insertStep,t=_.insertTime;return 0===_.dataHandler.waitInsertData.length?(_.dataHandler.setCardVisible(),_.dataHandler.currItemId?_.doModalByIndex("point"):_.doModalToFit(),void _.update()):new Promise((function(n){_.dataHandler.waitInsertData.length<200&&(e=_.hsInsertStep,t=_.hsInsertTime);var i=_.dataHandler.waitInsertData.splice(0,e);i.length>0&&(_.dataHandler.data=_.dataHandler.data.concat(i),_.update(),_.waitTimeout(t,n))})).then((function(){_.dataHandler.currItemId?_.doModalByIndex("point"):_.doModalToFit(),_.doInsertData()}))},_.getAllDataDraw=function(){var e=_.getCurrentData();return _.renderHandler.drawComment(),e},_.beforeModifyComment=function(e){var t=e.detail.bubbleId,n=_.dataHandler,i=n.hasTempComment,a=n.tempBubbleId;i&&t===a&&_.commitTempComment({callback:function(e){e||_.discardTempComment({isResetElements:!0,isUpdatePosition:!0})}}),_.getAllData(),_.update()},_.insertComment=(c=d()(regeneratorRuntime.mark((function e(t){var n,i,a,s,r,d,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(_.app.commentsDataManager.onInsertComment(),!t.comments){e.next=47;break}if(n=_.dataHandler.currItemId===t.comments.id&&_.dataHandler.isCurrItemExist(),sessionStorage.setItem("isExist_"+_.dataHandler.currItemId,!0),_.getAllDataDraw(),i=t.woUserId,a=_.renderHandler.cooperInfo.coopInfos,s=a.find((function(e){return e.tagid===i})),!(a.length>1&&s&&_.app.info&&_.app.info.userid&&s.userid!==_.app.info.userid)){e.next=15;break}return _.update(),e.next=12,_.waitTimeout();case 12:return _.doModalByIndex("",{},t.comments.id),sessionStorage.getItem("isExist_"+_.dataHandler.currItemId)&&sessionStorage.removeItem("isExist_"+_.dataHandler.currItemId),e.abrupt("return");case 15:if(!n){e.next=25;break}return _.update(),e.next=19,_.waitTimeout();case 19:return _.doModalByIndex(),e.next=22,_.waitTimeout();case 22:sessionStorage.getItem("isExist_"+_.dataHandler.currItemId)&&sessionStorage.removeItem("isExist_"+_.dataHandler.currItemId),e.next=44;break;case 25:if(r=t.comments.id,_.dataHandler.hasTempComment&&_.dataHandler.tempTrueBubbleId===r&&(r=_.dataHandler.tempBubbleId),d=_.dataHandler.dataIdObj[r],!r||!d){e.next=40;break}if(!_.dataHandler.hasTempComment||_.dataHandler.tempBubbleId!==r){e.next=34;break}m=_.dataHandler.dataIdObj[r],_.activeRender({data:m,id:r,range:{pos:t.pos,len:t.len},focus:!0,cb:null,type:null,forceUpdate:!1,useTrans:!0}),e.next=38;break;case 34:return _.update(),e.next=37,_.waitTimeout();case 37:_.doModalByIndex();case 38:e.next=44;break;case 40:return _.update(),e.next=43,_.waitTimeout();case 43:_.doModalByIndex();case 44:_.commentTip.visible||_.app.appApi.showComments({checked:!0,stored:!1}),e.next=52;break;case 47:return _.disableScrollFetch=!0,_.update(),e.next=51,_.waitTimeout();case 51:_.doModalToFitOther();case 52:w.default.dispatchEvent(w.default.comments.AFTER_COMMENT_INSERTED);case 53:case"end":return e.stop()}}),e,o)}))),function(e){return c.apply(this,arguments)}),_.changeText=function(e){if(_.app.commentShowStatus.commentPanel)w.default.dispatchEvent(w.default.comments.DRAW_CONTENT_BY_COMMENT,{});else{var t=_.judgeHasNewRevision(e),n=t.rc,i=t.hasNew;_.getAllDataDraw(),_.debounceUpdateText(e,n,i)}},_.editCommentBody=function(e){if(_.dataHandler.hasTempComment&&(_.getAllDataDraw(),_.update(),e.type===y.NOTIFY_TYPE.insertCommentText)){var t=_.dataHandler,n=t.tempBubbleId,i=t.tempRcId,a=t.dataIdObj[n],o=[].concat(s()(a?a.data.map((function(e){return e.rc_id})):[i]));_.app.data.selection.activeCommentPara([],o)}},_.debounceUpdateText=(p=d()(regeneratorRuntime.mark((function e(t,n,i){var a,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _.update(),e.next=3,_.waitTimeout();case 3:if(t.type!==y.NOTIFY_TYPE.setProp&&t.type!==y.NOTIFY_TYPE.delInsSame){e.next=17;break}if(!n){e.next=15;break}if(n.type!==y.CR_TYPE.comments){e.next=9;break}_.dataHandler.currItemId===n.id&&_.activeRender({range:n.range,id:n.id,focus:!1,data:n,cb:null,type:"point"}),e.next=15;break;case 9:if(!(n.data.length>0)){e.next=15;break}return a=void 0,s=void 0,n.data.forEach((function(e,t){var n=e,i=n.range||{pos:n.pos,len:n.len};if(0==t)s=i,a=t;else{var o=n.range||{pos:n.pos,len:n.len};o.pos===s.pos?o.len<=s.len&&(s=o,a=t):(s=o,a=t)}})),_.selectionCache=s,_.activeRender({range:s,id:n.data[a].rc_id,focus:!1,data:n.data[a],cb:null,type:"point",forceUpdate:i}),e.abrupt("return");case 15:e.next=20;break;case 17:if(!_.dataHandler.currItemId){e.next=20;break}return _.doModalByIndex("point"),e.abrupt("return");case 20:t.type!==y.NOTIFY_TYPE.insertComment&&_.judgeFitOrOther();case 21:case"end":return e.stop()}}),e,o)}))),function(e,t,n){return p.apply(this,arguments)}),_.deleteComment=(f=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(_.app.commentsDataManager.onDeleteComment(),_.getAllDataDraw(),_.update(),!(t.comments&&t.comments.data&&t.comments.data.length>0)){e.next=11;break}return _.resetTempCommentWhenDeleted(!1),_.update(),e.next=8,_.waitTimeout();case 8:_.doModalByIndex(),e.next=17;break;case 11:return _.resetTempCommentWhenDeleted(!0),_.dataHandler.tempBubbleId&&_.dataHandler.setModalVisibleById(_.dataHandler.tempBubbleId),_.update(),e.next=16,_.waitTimeout();case 16:_.doModalToFitOther();case 17:case"end":return e.stop()}}),e,o)}))),function(e){return f.apply(this,arguments)}),_.setActive=(v=d()(regeneratorRuntime.mark((function e(t,n,i,a,s){var r,d=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],m=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=3;break}return console.log("id incorrect"),e.abrupt("return",!1);case 3:if(i&&H.isIPad&&Object(A.focusOnOtherInput)(),_.dataHandler.currItemId===n&&!m){e.next=13;break}return _.dataHandler.setModalVisibleById(n),_.update(),_.dataHandler.currItemId!==y.TEMP&&_.dataHandler.deleteCommentGroupById(y.TEMP,void 0,!1,!0),e.next=10,_.waitTimeout();case 10:r=_.getNextScroll(n,i),_.doModalByIndex(s,null,n,r),a&&a.call(_);case 13:if(!i){e.next=23;break}if(!d){e.next=17;break}e.next=20;break;case 17:return e.next=19,_.waitTimeout(200);case 19:_.update();case 20:_.disableScrollFetch=!0,_.app.workspace.makesureCursorVisible(!0,!1,!0),_.app.workspace.resizeIfNecessary({});case 23:case"end":return e.stop()}}),e,o)}))),function(e,t,n,i,a){return v.apply(this,arguments)}),_.onActive=function(e,t,n){if(t!==y.TEMP){var i=_.dataHandler.tempCommentId;if(t===_.dataHandler.tempBubbleId)if(n.data.find((function(t){return t.comment_id===i&&Object(z.isRangeIntersect)({pos:t.pos,len:t.len},e)})))return;var a=n.type===y.CR_TYPE.comments;_.dataHandler.hasTempComment&&_.commitTempComment({isUpdatePosition:!1,callback:function(e){e||_.discardTempComment({isResetElements:!0})}}),_.onActiveRenderAndSetPos(e,t,n),_.selectionCache=e,a||(void 0!==e.idx&&e.docType!==y.DOC_TYPE.main&&_.app.data.selection.selContext.setHeaderfooterLayoutIndex(e.idx),_.app.data.selection.setPosition(e.pos),_.renderHandler.inactiveCommentPara()),window.collection("commandbar","click","comment_card")}},_.onDidMount=function(){_.didMount=!0;var e=_.handleBookmark();e?_.setActive(null,e):_.setModalPos(),_.firstLocatePos=_.getFirstLocatePos(),_.showRevisionHandle(!0)},_.onClose=function(e){if(_.isCommentBubbleStatus&&_.dataHandler.currItemId){if(_.dataHandler.hasTempComment)if(e&&!_.isReEditComment){var t=_.app.editor.cmdExecutor.getCurrentLocalCommand();if(t&&"insertComment"!==t.name)return;var n=_.dataHandler.dataIdObj[y.TEMP];n&&n.data&&1===n.data.length?_.dataHandler.ModifyModalToFitPart(_.dataHandler.tempBubbleId,!0,!1):_.setModalLandscape(!1),_.discardTempComment({isForce:!0,isResetContext:!0,isResetElements:!0,isUpdatePosition:!0})}else _.commitTempComment({callback:function(e){e?_.setModalLandscape(!1):_.discardTempComment({isResetElements:!0,isUpdatePosition:!0})}});else{var i=_.app.data.selection.selContext;i.isInComment()&&_.resetCommentSelection({comment_id:i.commentId}),_.setModalLandscape(!1)}_.app.uilManager.uiHandler.handleFocusEvent(!0),_.app.workspace.resizeIfNecessary(),_.renderHandler.inactiveCommentPara(),_.renderHandler.outCommentPara(),_.selectionCache={}}},_.onEditItem=function(e){var t=_.app.data.doc.comments.getCommentByCommentId(e.comment_id);if(t){_.dataHandler.hasTempComment&&_.discardTempComment({isResetContext:!0,bSendSelectionBack:!1});var n=t.body.pos+t.body.len-1;_.app.data.selection.setPosition(n,n,{isSend:!0}),_.dataHandler.setEditingCommentId(t.comment_id),_.restoreTempComment(),_.app.data.selection.setPosition(t.pos,t.pos+t.len)}},_.onDeleteItem=(g=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return console.warn("wrong comment"),e.abrupt("return");case 3:_.dataHandler.hasTempComment?_.commitOrDiscardComment():_.app.data.selection.selContext.isInComment()&&_.resetCommentSelection(t),t.comment_id?_.app.services.userCommentsManager.docUserCommentsHandle.removeCommentById(t.comment_id):_.app.services.userCommentsManager.docUserCommentsHandle.removeCommentByLocalId(t.rc_id);case 5:case"end":return e.stop()}}),e,o)}))),function(e){return g.apply(this,arguments)}),_.onHover=function(e,t,n){n===y.CR_TYPE.comments&&_.renderHandler.hoverCommentPara({detail:{range:e,comments:t,isPara:!0}})},_.onLeave=function(e,t,n){n===y.CR_TYPE.comments&&_.renderHandler.outCommentPara()},_.handleGetOnline=function(e){var t=e.detail,n=t.modal_id,i=t.comment;_.waitGetComments.push(i),_.waitRefreshModal.push(n),_.debounceGetOnline()},_.doGetOnline=d()(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=_.waitGetComments,_.waitGetComments=[],e.next=4,_.app.servicesLoader.commentsDataManager.getComments(t);case 4:n=_.waitRefreshModal,_.waitRefreshModal=[],w.default.dispatchEvent(w.default.comments.GET_ONLINE_COMMENTS_END,{ids:Array.from(new Set(n))}),_.renderHandler.drawComment();case 8:case"end":return e.stop()}}),e,o)}))),_.setModalPos=(C=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _.dataHandler.setModalVisibleById(t&&t.id),_.update(t),e.next=4,_.waitTimeout();case 4:_.doModalToFit(t);case 5:case"end":return e.stop()}}),e,o)}))),function(e){return C.apply(this,arguments)}),_.setModalLandscape=(b=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _.dataHandler.setModalVisibleById(),_.update(),e.next=4,_.waitTimeout();case 4:_.doModalToFit();case 5:case"end":return e.stop()}}),e,o)}))),function(e){return b.apply(this,arguments)}),_.doModelToScroll=function(){var e=_.dataHandler.getVisibleData();_.dataHandler.currItemId&&e.find((function(e){return e.id===_.dataHandler.currItemId}))?_.doModalByIndex("point"):_.doModalToFit()},_.doModalToFit=function(e){_.dataHandler.ModifyModalToFit(),_.update(e)},_.doModalByIndex=function(e,t,n,i){_.dataHandler.ModifyModalByIndex(e,n,i),_.update(t)},_.doModalToFitOther=function(){_.dataHandler.ModifyOtherModalToFit(),_.update()},_.doModalToFitOtherBySpecific=function(e){_.dataHandler.ModifyModalToFitPart(e,!1),_.update()},_.refresh=(I=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(_.isCommentBubbleStatus){e.next=2;break}return e.abrupt("return");case 2:if(0!==_.dataHandler.getData().length&&_.didMount){e.next=4;break}return e.abrupt("return",!1);case 4:"resize"===t?(_.height=document.getElementById("workspace").offsetHeight,_.commentTip.resize(),_.getAllDataDraw(),_.dataHandler.currItemId&&_.dataHandler.getVisibleData().find((function(e){return e.id===_.dataHandler.currItemId}))?_.doModalByIndex("point"):_.doModalByIndex(null)):"scale"===t?requestAnimationFrame((function(){_.openModalByRange(_.app.data.selection.getNormalRange())})):(_.dataHandler.setModalVisibleById(null),_.setModalPos());case 5:case"end":return e.stop()}}),e,o)}))),function(e){return I.apply(this,arguments)}),_.updateLayout=function(){if(!_.app.commentShowStatus.commentPanel){if(0===_.dataHandler.getData().length||!_.didMount)return!1;var e=_.dataHandler.currItemId&&_.dataHandler.getVisibleData().find((function(e){return e.id===_.dataHandler.currItemId}));_.updateLayoutFrame&&cancelAnimationFrame(_.updateLayoutFrame),_.updateLayoutFrame=requestAnimationFrame((function(){e?_.doModalByIndex("point"):_.doModalToFit(),_.updateLayoutFrame=null}))}},_.locateCommentContent=function(e){var t=e.detail,n=t.range,i=t.bubbleId;_.setActive(n,i)},_.onActiveEvent=function(e){var t=e.detail,n=t.range,i=t.id,a=t.data;_.onActive(n,i,a)},_.onAddItemEvent=(E=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_.insertTempComment(t.detail.params);case 2:case"end":return e.stop()}}),e,o)}))),function(e){return E.apply(this,arguments)}),_.onEditItemEvent=function(e){_.onEditItem(e.detail.params)},_.onDeleteItemEvent=(T=d()(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_.onDeleteItem(t.detail.params);case 2:case"end":return e.stop()}}),e,o)}))),function(e){return T.apply(this,arguments)}),_.onDeleteItemsEvent=function(e){var t=e&&e.detail&&e.detail.comments;t&&(_.dataHandler.hasTempComment&&_.discardTempComment(),_.app.services.userCommentsManager.docUserCommentsHandle.removeComments(t))},_.onReplyItemEvent=function(e){var t=e.detail.params.replyId;if(void 0!==t){if(_.dataHandler.tempReplyId===t&&!_.dataHandler.reEditCommentId)return _.workspace.updateCommentIndicator(!0,!0),void setTimeout((function(){return _.workspace.locateTimeoutID&&clearTimeout(_.workspace.locateTimeoutID)}));_.commitOrDiscardComment(),H.isIPad&&Object(A.focusOnOtherInput)()}_.insertTempComment({replyId:t})},_.onCancelReplyItemEvent=function(e){_.discardTempComment({isForce:!0,isUpdatePosition:!0})},_.onHoverEvent=function(e){var t=e.detail,n=t.range,i=t.data,a=t.type;_.onHover(n,i,a)},_.onLeaveEvent=function(e){var t=e.detail,n=t.pos,i=t.data,a=t.type;_.onLeave(n,i,a)},_.onCloseEvent=function(e){_.onClose(e.detail.isDiscardComment)},_.onDidMountEvent=function(){_.onDidMount()},_.update=function(e){if(!_.workspace.unMount){var t=e&&e.left||_.dataHandler.left,n=_.dataHandler.getViewData(!0),i=n.data,a=n.tops,o=n.ranges,s=n.length;_.dataHandler.setLeft(t),_.renderHandler.render({tops:a,ranges:o,data:i,length:s,currId:_.dataHandler.currItemId,replyId:_.dataHandler.tempReplyId})}},_.scaleContainer=a,_.debounceUpdateText=window.utils.Lodash.debounce(_.debounceUpdateText,150),_.refresh=window.utils.Lodash.debounce(_.refresh,100),_.debounceGetOnline=window.utils.Lodash.debounce(_.doGetOnline,100),_.debounceModifyModalToFit=window.utils.Lodash.debounce(_.doModalToFit,100),_.debounceModifyModalByIndex=window.utils.Lodash.debounce(_.doModalByIndex,100),_.debounceViewportChange=window.utils.Lodash.debounce(_.viewportChange,100),_.debounceShowCommentsHandle=window.utils.Lodash.debounce(_.showCommentsHandle,100),_.onScroll=J()(_.onScrollSlide,100,{leading:!1}),_.onScrollVisible=window.utils.Lodash.throttle(_.onScrollVisible,100),_.updateLayout=window.utils.Lodash.debounce(_.updateLayout,300),_.updateLayoutFrame=null,_.commentTip=new F(e,n,a),_.dataHandler=new D(e,n,_),_.commentComponentManager=new G.a,_.selectionCache={},_.didMount=!1,_.waitGetComments=[],_.waitRefreshModal=[],_.usedPageMax=0,_.allUsedPageMax=0,_.bookmarkInfo=_.app.initializedBookmarkInfo,_.templateShowTime=0,_.currentActiveCommentRange=null,_.init(),_.height=_.app.workspace.element.cacheDOMAttr.offsetHeight,_.scrollTop=0,_.firstLocatePos=0,_.usedPage=[],_.zoom=_.app.workspace.config.zoom,_.revisionVisibleStatus=!1,_.insertStep=10,_.insertTime=50,_.hsInsertStep=20,_.hsInsertTime=30,_}var n,i,o;return C()(t,e),c()(t,[{key:"bindFixedEvents",value:function(){this.isBindFixedEvents||(this.isBindFixedEvents=!0,window.addEventListener(w.default.comments.ON_COMMENT_SHOW_STATUS_UPDATE,this.onCommentShowStatusUpdate),window.addEventListener(w.default.comments.SHOW_COMMENTS,this.debounceShowCommentsHandle),window.addEventListener(w.default.comments.ON_DID_MOUNT,this.onDidMountEvent),window.addEventListener(w.default.revision.ENABLE_REVISION,this.trackRevisionHandle),window.addEventListener(w.default.revision.REVISION_SETTINGS_CHANGE,this.showRevisionHandle),window.addEventListener(w.default.names.DOC_COOPERATION_MODE_TOGGLED,this.showRevisionHandle),window.addEventListener(w.default.revision.REVISION_ACCEPTREFUSE,this.revisionAcceptRefuse),window.addEventListener(w.default.revision.SHOW_REVISION_BUBBLE,this.showRevisionBubble),window.addEventListener(w.default.comments.INSERT_EMOJI_COMMENT_BY_BTN,this.insertCommentByEmoji),window.addEventListener(w.default.comments.ON_DELETE_ITEMS,this.onDeleteItemsEvent),window.addEventListener(w.default.comments.GET_ONLINE_AUDIT_COMMENTS,this.updateCommentStatus))}},{key:"bindDynamicEvents",value:function(){this.isBindDynamicEvents||(this.isBindDynamicEvents=!0,this.app.data.doc.attachObserver(this),this.app.data.doc.reviewMgr.attachObserver(this),window.addEventListener(w.default.comments.ACTIVE_COMMENT_BY_RANGE,this.activeCommentByRange),window.addEventListener(w.default.comments.INACTIVE_COMMENT,this.inactiveComment),window.addEventListener(w.default.comments.ON_ADD_ITEM_BY_BTN,this.openCommentsModal),window.addEventListener(w.default.comments.GET_ONLINE_COMMENTS,this.handleGetOnline),window.addEventListener(w.default.comments.ON_ACTIVE,this.onActiveEvent),window.addEventListener(w.default.comments.ON_ADD_ITEM_BY_MODAL,this.onAddItemEvent),window.addEventListener(w.default.comments.ON_EDIT_ITEM,this.onEditItemEvent),window.addEventListener(w.default.comments.ON_DELETE_ITEM,this.onDeleteItemEvent),window.addEventListener(w.default.comments.ON_REPLY_ITEM,this.onReplyItemEvent),window.addEventListener(w.default.comments.ON_CANCEL_REPLY_ITEM,this.onCancelReplyItemEvent),window.addEventListener(w.default.comments.ON_HOVER,this.onHoverEvent),window.addEventListener(w.default.comments.ON_LEAVE,this.onLeaveEvent),window.addEventListener(w.default.comments.ON_CLOSE,this.onCloseEvent),window.addEventListener(w.default.view.BEFORE_VIEW_MODE_CHANGED,this.beforeViewModeChanged),window.addEventListener(w.default.comments.ON_EXIT_COMMENT_BODY,this.onExitComment),window.addEventListener(w.default.comments.COMMIT_AND_INSERT_NEW_COMMENT,this.commitAndInsertNewTempComment),window.addEventListener(w.default.restrictEdit.ON_RESTRICT_STATE_CHANGE,this.handleRestrictEditModeChange),window.addEventListener(w.default.names.DOC_UNDO_REDO,this.handleUndoRedo),window.addEventListener(w.default.comments.MENTION_IN_COMMENT,this.mentionInComment),window.addEventListener(w.default.comments.BEFORE_MODIFY_COMMENT,this.beforeModifyComment),window.addEventListener(I.default.names.ON_BEFORE_UNLOAD,this.onBeforeUnload),window.addEventListener(w.default.comments.COMMENT_UPDATE_LAYOUT,this.updateLayout),window.addEventListener(w.default.comments.SCROLL_FIND_COMMENT,this.locateCommentContent))}},{key:"bindEvents",value:function(){this.bindFixedEvents(),this.app.commentShowStatus.commentBubble&&this.bindDynamicEvents()}},{key:"unbindFixedEvents",value:function(){this.isBindFixedEvents&&(this.isBindFixedEvents=!1,window.removeEventListener(w.default.comments.ON_COMMENT_SHOW_STATUS_UPDATE,this.onCommentShowStatusUpdate),window.removeEventListener(w.default.comments.SHOW_COMMENTS,this.debounceShowCommentsHandle),window.removeEventListener(w.default.comments.ON_DID_MOUNT,this.onDidMountEvent),window.removeEventListener(w.default.revision.ENABLE_REVISION,this.trackRevisionHandle),window.removeEventListener(w.default.revision.REVISION_SETTINGS_CHANGE,this.showRevisionHandle),window.removeEventListener(w.default.names.DOC_COOPERATION_MODE_TOGGLED,this.showRevisionHandle),window.removeEventListener(w.default.revision.REVISION_ACCEPTREFUSE,this.revisionAcceptRefuse),window.removeEventListener(w.default.revision.SHOW_REVISION_BUBBLE,this.showRevisionBubble),window.removeEventListener(w.default.comments.INSERT_EMOJI_COMMENT_BY_BTN,this.insertCommentByEmoji),window.removeEventListener(w.default.comments.ON_DELETE_ITEMS,this.onDeleteItemsEvent),window.removeEventListener(w.default.comments.GET_ONLINE_AUDIT_COMMENTS,this.updateCommentStatus))}},{key:"unbindDynamicEvents",value:function(){this.isBindDynamicEvents&&(this.isBindDynamicEvents=!1,this.app.data.doc.detachObserver(this),this.app.data.doc.reviewMgr.detachObserver(this),window.removeEventListener(w.default.comments.ACTIVE_COMMENT_BY_RANGE,this.activeCommentByRange),window.removeEventListener(w.default.comments.INACTIVE_COMMENT,this.inactiveComment),window.removeEventListener(w.default.comments.ON_ADD_ITEM_BY_BTN,this.openCommentsModal),window.removeEventListener(w.default.comments.GET_ONLINE_COMMENTS,this.handleGetOnline),window.removeEventListener(w.default.comments.ON_ACTIVE,this.onActiveEvent),window.removeEventListener(w.default.comments.ON_ADD_ITEM_BY_MODAL,this.onAddItemEvent),window.removeEventListener(w.default.comments.ON_EDIT_ITEM,this.onEditItemEvent),window.removeEventListener(w.default.comments.ON_DELETE_ITEM,this.onDeleteItemEvent),window.removeEventListener(w.default.comments.ON_REPLY_ITEM,this.onReplyItemEvent),window.removeEventListener(w.default.comments.ON_CANCEL_REPLY_ITEM,this.onCancelReplyItemEvent),window.removeEventListener(w.default.comments.ON_HOVER,this.onHoverEvent),window.removeEventListener(w.default.comments.ON_CLOSE,this.onCloseEvent),window.removeEventListener(w.default.view.BEFORE_VIEW_MODE_CHANGED,this.beforeViewModeChanged),window.removeEventListener(w.default.comments.ON_EXIT_COMMENT_BODY,this.onExitComment),window.removeEventListener(w.default.comments.COMMIT_AND_INSERT_NEW_COMMENT,this.commitAndInsertNewTempComment),window.removeEventListener(w.default.restrictEdit.ON_RESTRICT_STATE_CHANGE,this.handleRestrictEditModeChange),window.removeEventListener(w.default.names.DOC_UNDO_REDO,this.handleUndoRedo),window.removeEventListener(w.default.comments.MENTION_IN_COMMENT,this.mentionInComment),window.removeEventListener(w.default.comments.BEFORE_MODIFY_COMMENT,this.beforeModifyComment),window.removeEventListener(I.default.names.ON_BEFORE_UNLOAD,this.onBeforeUnload),window.removeEventListener(w.default.comments.COMMENT_UPDATE_LAYOUT,this.updateLayout),window.removeEventListener(w.default.comments.SCROLL_FIND_COMMENT,this.locateCommentContent))}},{key:"unbindEvents",value:function(){this.unbindFixedEvents(),this.app.commentShowStatus.commentBubble&&this.unbindDynamicEvents()}},{key:"clearAll",value:function(){v()(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"clearAll",this).call(this),this.disableScrollFetch=!0,this.commentTip.clearAll(),this.updateLayoutFrame&&cancelAnimationFrame(this.updateLayoutFrame)}},{key:"adjustCommentPosOnInsertText",value:function(e,t,n){return t<=e?e+n.length:e}},{key:"onInsertText",value:function(e,t,n,i){if(e===this.app.data.doc){var a=this.app.data.selection.selContext;a.isInComment()&&!isNaN(a.commentPos)&&(a.commentPos=this.adjustCommentPosOnInsertText(a.commentPos,t,n))}}},{key:"adjustCommentPosOnDeleteText",value:function(e,t,n){var i=t+n.length;return i<=e?e-n.length:t<e&&i>e?t:e}},{key:"onDeleteText",value:function(e,t,n,i){if(e===this.app.data.doc){var a=this.app.data.selection.selContext;a.isInComment()&&!isNaN(a.commentPos)&&(a.commentPos=this.adjustCommentPosOnDeleteText(a.commentPos,t,n))}}},{key:"onInput",value:(o=d()(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.dataHandler.hasTempComment||!this.dataHandler.isNotifyTempComment){e.next=13;break}if(!this.tempCommentCommitPromise){e.next=5;break}return e.next=4,this.tempCommentCommitPromise;case 4:return e.abrupt("return",!1);case 5:return t=this.dataHandler.tempRcId,n=this.app.data.doc.comments.getCommentByRcId(t)||{},this.tempCommentCommitPromise=this.app.servicesLoader.commentsDataManager.commitComment(n),e.next=10,this.tempCommentCommitPromise;case 10:return this.tempCommentCommitPromise=null,this.dataHandler.isNotifyTempComment=!1,e.abrupt("return",!1);case 13:return e.abrupt("return",!0);case 14:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"commitTempComment",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.callback,i=t.resetNow,o=this.workspace.commentInput;if(!o||!o.element||!o.value)return this.app.uilManager.resetCommentElements(),n&&n(!1),!1;var s=o.value,r=s.content,d=s.count,m=s.contents,l=s.nodes;if(!d)return n&&n(!1),!1;if(this.isMakingComment)return n&&n(!1),!1;window.collection("commandbar","click","comment_send"),this.isMakingComment=!0;var u=this.dataHandler,c=u.tempRange,p=u.tempReplyId,h=u.reEditCommentId;i&&(this.dataHandler.resetTempCommentBubble(),this.app.uilManager.resetCommentElements());var f={text:r,cid:h,p_comment_id:p};window.__WPSENV__.reduxDispatch(Object(U.commentReviewAsync)(f)).then((function(t){if(t.error);else if(t&&t.response&&t.response.body){var o=t.response.body,s=o.comment_id,d=o.user_info,u=o.p_comment_id,f=o.content,v=void 0===f?{}:f,g=o.time,C=u||p,b={range:c,text:r,replyId:C,isReply:!!C,contents:m,content:a()({},v,{text:v.text||r}),comment_id:s,time:g,user_info:d,p_comment_id:C};i||(e.dataHandler.resetTempCommentBubble(),e.app.uilManager.resetCommentElements());var I=h?e.app.commentsDataManager.modifyComment(a()({},b,{commentId:s})):e.app.commentsDataManager.commitTempComment(a()({},b,{commentId:s}));if(!I)return n&&n(!1),!1;var y=c,E=e.app.data.doc.commentBubbles.getBubbleByRange(c.pos,c.len);E&&(y=E.range),e.app.servicesLoader.commentsDataManager.setCommentCacheObjProperty(s,b),e.app.commentsDataManager.notifyComment({id:h||I.comment_id,isVoice:!1,text:r,duration:0}),w.default.dispatchEvent(w.default.comments.COMMENT_INSERTOREDIT_SUCCESS,{type:h?"edit":"insert",commentId:h||I.comment_id,nodes:l}),n&&n(!h&&y)}})).finally((function(){e.isMakingComment=!1}))}},{key:"resetTempComment",value:function(e){this.dataHandler.resetTempCommentBubble(),this.app.uilManager.exitCommentBody()}},{key:"discardTempComment",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.isForce,n=void 0!==t&&t,i=e.isResetContext,a=void 0!==i&&i,o=e.isResetElements,s=void 0!==o&&o,r=e.isUpdatePosition,d=void 0!==r&&r,m=e.bSendSelectionBack,l=void 0===m?H.isPad:m;if(this.dataHandler.hasTempComment)return this.dataHandler.resetTempCommentBubble(),this.app.uilManager.exitCommentBody(),this.app.data.selection.setPosition(this.app.data.selection.begin.pos),void this.update();var u=this.dataHandler.tempRcId,c=this.app.data.doc.comments.getCommentByRcId(u)||{},p=c.body,h=c.pos,f=c.len,v=c.comment_id;p&&(a&&this.app.data.selection.exitCommentBody(),s&&this.app.uilManager.resetCommentElements(),p.len<=1||n?(this.app.editor.cmdExecutor.exec({name:"resetComment",param:{pos:h,len:f,bSendSelectionBack:l}}),this.app.viewUIL.typoUpdate()):(window.collection("commandbar","click","comment_send"),this.app.commentsDataManager.notifyComment({id:v,isVoice:!1,text:this.app.data.doc.getText(p.pos,p.len),duration:0})),this.dataHandler.resetTempCommentBubble(),this.update(),d&&this.app.data.selection.setPosition(h,h+Math.max(f-1,0),{isSend:!0}))}},{key:"commitOrDiscardComment",value:function(){var e=this;this.commitTempComment({isUpdatePosition:!0,callback:function(t){t||e.discardTempComment({isForce:!1,isUpdatePosition:!0})}})}},{key:"restoreTempComment",value:function(){var e=this.app.data,t=e.selection,n=e.doc,i=t.getNormalRange(),a=n.commentBodys.getCommentByPos(i.pos);if(a){var o=a.comment_id,s=a.rc_id,r=a.pos,d=a.len,m=n.commentBubbles.getBubbleByRange(r,d);if(m){var l=m.id,u=m.range,c=u.pos,p=u.len,h=!this.dataHandler.hasTempComment||this.dataHandler.tempBubbleId!==l,f={pos:c,len:p},v=this.app.commentsDataManager.getCommentCache(o),g=v&&v.p_comment_id;this.dataHandler.setTempCommentBubble({commentId:o,rcId:s,bubbleId:l,replyId:g,range:f,isNotifyTempComment:!1}),this.getAllDataDraw(),h?this.setActive(f,l,!1,null,"",!1,!0):this.update(),this.dataHandler.ModifyModalByIndex("",l)}}}},{key:"switchTempComment",value:function(){var e=this.app.data.selection;this.dataHandler.tempRcId!==e.selContext.getCommentRcId()&&(this.app.uilManager.resetCommentElements(),this.restoreTempComment())}},{key:"resetCommentSelection",value:function(e){var t=void 0,n=void 0;switch(!0){case void 0!==e.pos&&void 0!==e.len:t=e.pos+e.len-1;break;case void 0!==e.comment_id:t=(n=this.app.data.doc.comments.getCommentByCommentId(e.comment_id)).pos+n.len-1;break;case void 0!==e.rc_id:t=(n=this.app.data.doc.comments.getCommentByRcId(e.rc_id)).pos+n.len-1}this.app.uilManager.resetCommentElements(),this.app.data.selection.setPosition(t,t,{isSend:!0})}},{key:"openCommentsModalByRange",value:function(e){var t=this,n=this.app.data.doc.commentBubbles.getBubbleByRange(e.pos,e.len);if(n&&0!==n.length&&this.commentVisible){var i=this.dataHandler.currItemId===n.id;this.selectionCache=e,i||this.activeRender({range:e,id:n.id,focus:!0,data:n,cb:null,type:"point"}),requestAnimationFrame((function(){t.insertTempComment({range:e})}))}else this.insertTempComment({range:e})}},{key:"adjustCommentRange",value:function(){var e=this.app.data.selection,t=e.getNormalRange(),n=window.APP.restrictEditHandler.readonlyProtection.adjustEditableRange(t);n.pos===t.pos&&n.len===t.len||e.setPosition(n.pos,n.pos+n.len,{isSend:!0})}},{key:"trackChange",value:function(){w.default.dispatchEvent(w.default.revision.REVISION_TRACK_CHANGE,{isTrackingChanges:this.app.data.doc.textStream.getRevisionTextStream().isTrackingChanges})}},{key:"handleBookmark",value:function(){if(this.app.isFirstTimeHandleBookmark){var e=this.bookmarkInfo;if(!e)return;var t=e.inComment,n=e.commentRange;if(!t)return;return this.selectionCache=n,this.app.data.doc.commentBubbles.getBubbleByRange(n.pos).id}}},{key:"trackRevisionHandle",value:function(e){var t=e.detail.enable;window.APP.data.doc.textStream.getRevisionTextStream().setTrackChanges(t)}},{key:"diff",value:function(e){if("[object Array]"===window.utils.Lodash.getType(e)&&0!==e.length){var t=Math.max.apply(Math,s()(e));return t!==this.usedPageMax&&(this.usedPageMax=t,!0)}console.log("need array")}},{key:"create",value:(i=d()(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.usedPageMax=0,this.getAllDataDraw(),Object(E.hasQuery)("version")?(this.update(),this.allData||this.versionCompare||(this.versionCompare=new R(this.workspace,this,this.app),this.allData=this.versionCompare.allData),this.renderHandler.drawComment()):(this.firstLocatePos=this.getFirstLocatePos(),this.update({left:this.dataHandler.getLeft()}),this.workspace.resizeIfNecessary());case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"onScrollSlide",value:(n=d()(regeneratorRuntime.mark((function e(t){var n,i,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isCommentBubbleStatus){e.next=2;break}return e.abrupt("return");case 2:if(this.scrollTop=this.app.workspace.element.cacheDOMAttr.scrollTop,!this.disableScrollFetch){e.next=6;break}return this.disableScrollFetch=!1,e.abrupt("return");case 6:if(!(this.diffPages(t)&&this.app.servicesLoader&&this.app.servicesLoader.commentsDataManager)){e.next=15;break}if(!Object(E.hasQuery)("version")){e.next=10;break}return e.next=10,this.versionCompare.getDocData();case 10:n=this.dataHandler.findCommentGroupById(y.TEMP),i=this.dataHandler.currItemId,a=null,-1!==n&&void 0!==n&&(a=this.dataHandler.data[n],(o=T.b.locate(this.app.data,a.range.pos,null,this.app.data.typoinfo,"line"))&&void 0!==o.layoutIndex||(i===y.TEMP?(a=null,this.dataHandler.setModalVisibleById(null)):a=null)),this.getScrollData();case 15:this.dataHandler.setCardVisible(),this.update(),this.workspace.resizeIfNecessary({preventFocus:!0}),this.judgeUsedPage()&&(this.renderUsedPage=[].concat(s()(this.app.workspace.currentUsedPage)),this.renderHandler.drawComment());case 19:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"onScrollVisible",value:function(){this.isCommentBubbleStatus&&(this.dataHandler.setCardVisible(),this.update())}},{key:"judgeUsedPage",value:function(){var e=this.app.workspace.currentUsedPage;if(!this.renderUsedPage||!e)return!0;if(this.renderUsedPage.length!==e.length)return!0;for(var t=0;t<this.renderUsedPage.length;t++)if(this.renderUsedPage[t]!==e[t])return!0;return!1}},{key:"selectionChange",value:function(e,t){if(this.isCommentBubbleStatus&&(this.dataHandler.onSelectionChanged(),this.workspace.commentRenderHandler.onSelectionChanged(),this.app.data.doc.getSubDocType(e.pos)!==O.Comment)){if(!t)return void console.log("no param");if(this.commentTip.updateAddPos(),t.isClick||t.isTripleTap)this.openModalByRange(e);else try{var n=this.app.workspace.revisionComment.dataHandler.getCurrentCommentRange();if(window.APP.restrictEditHandler.isInRestrictEditMode)return;if(n){var i=e.pos,a=i+e.len,o=n.pos,s=o+n.len;if(o<=i&&s>=a)return;this.openModalByRange(e)}}catch(e){}}}},{key:"backfillCurr",value:function(e){var t=this.dataHandler.currItemId,n=this.dataHandler.dataIdObj[t];if(t&&n&&!this.dataHandler.data.find((function(e){return e.id===t}))){var i=this.app.data.doc.commentBubbles.getBubbleById(t);if(!i)return;var a=i.pos,o=i.len;n.range.pos=a,n.range.len=o;var s=this.app.data.typoinfo.layout_pages;e.map((function(e){var t=s[e];return t.range||t.page.range})).some((function(e){return Math.max(a,e.pos)<=Math.min(a+o,e.pos+e.len)}))&&this.dataHandler.data.unshift(n)}}},{key:"onModifyComments",value:function(e,t){t.changes.some((function(e){return e.diff.isDone}))&&(this.getAllData(),this.update(),this.renderHandler.drawComment())}},{key:"judgeHasNewRevision",value:function(e){var t=this,n=!1,i=void 0;if(e.type===y.NOTIFY_TYPE.setProp||e.type===y.NOTIFY_TYPE.delInsSame){var a=this.app.data.selection.getNormalRange();if((i=this.dataHandler.getRevisionAndCommentData(a))&&i.type!==y.CR_TYPE.comments)if(i.data.length>0)i.data.filter((function(e){return t.dataHandler.dataIdObj[e.rc_id]}))&&(n=!0)}return{hasNew:n,rc:i}}},{key:"resetTempCommentWhenDeleted",value:function(e){var t=this.app.uilManager.undoRedoHandler.state.isUndoRedo,n=this.app.isCmdExecutingByCurrentUser;if(this.dataHandler.hasTempComment){var i=this.app.data.doc,a=this.dataHandler.tempCommentId,o=!a||a===y.TEMP||i.commentBubbles.getBubbleById(a),s=!e&&this.dataHandler.tempReplyId?i.comments.getCommentByCommentId(this.dataHandler.tempReplyId):null;if(!t)return o||n?s||!this.dataHandler.tempReplyId||n||window.Toast.info(_i18n("applications.writer.components.other.Comment.replyCommentDeletedByCooper", "The comment you referenced has been deleted.")):(this.resetTempComment(),window.Toast.info(_i18n("applications.writer.components.other.Comment.commentDeletedByCooper", "Other collaborators have deleted the comment"))),!0;o||this.resetTempComment()}return!1}},{key:"judgeFitOrOther",value:function(){if(!this.dataHandler.currItemId){var e=this.getFirstLocatePos();e!==this.firstLocatePos?(this.firstLocatePos=e,this.doModalToFit()):this.doModalToFitOther()}}},{key:"getNextScroll",value:function(e,t){var n=this.dataHandler.dataIdObj[e];if(!n||!t)return this.scrollTop;return this.dataHandler.getPosByRange(n.range)-this.app.workspace.element.clientHeight/2+30}},{key:"activeRender",value:function(e){var t=e.range,n=e.id,i=e.focus,a=void 0!==i&&i,o=e.data,s=e.cb,r=e.type,d=e.forceUpdate,m=e.useTrans,l=void 0===m||m;this.renderHandler.outCommentPara(),this.setActive(t,n,a,s,r,l,d),this.app.data.selection.inactiveCommentPara(),o.type===y.CR_TYPE.comments&&o.data.length>0&&this.renderHandler.activeCommentPara({detail:{range:t,comments:o.data,isPara:!0}}),Object(E.hasQuery)("version")&&this.versionCompare&&w.default.dispatchEvent(w.default.revision.REVISION_ACTIVE_CHANGE,{curId:n,data:this.versionCompare.allData})}},{key:"onActiveRenderAndSetPos",value:function(e,t,n,i){if(this.activeRender({range:e,id:t,focus:!1,data:n,cb:i}),n.type===y.CR_TYPE.comments&&n.data.length>0){var a=n.data[0].pos;this.app.data.selection.setPosition(a,null,{updateOnly:!0,isComment:!0,isSend:!0}),this.makeCommentAreaVisible(a)}}},{key:"getFirstLocatePos",value:function(){var e=this.dataHandler.data;if(e&&e.length>0){var t=(e=this.dataHandler.data[0]).range.pos,n=this.app.data.typoinfo.pagePos,i=0;if(n)for(var a=0;a<n.length;a++)if(a.beginPos<t&&a.endPos>t){i=a;break}return this.app.data.typoinfo.getLayoutPageCache(i),T.b.locate(this.app.data,e.range.pos,null,this.app.data.typoinfo,"line").posY*this.app.workspace.config.zoom}return!1}},{key:"realTimeRefresh",value:function(e){this.isCommentBubbleStatus&&(this.update(),this.refresh(e))}},{key:"checkIsCommentOrRevisionBubbleEditable",value:function(e){var t=e.type;if(this.app.data.selection.selContext.isParagraphSetting)return!1;var n=e.range,i=n.len,a=n.pos,o=Object(W.checkIfCommentOrRevisionEditable)({begin:a,end:a+i,type:t});return"comments"===e.type?!(this.app.restrictEditHandler.isInRestrictEditMode||!e.isTemp)||!!o&&(!(!this.app.data.selection.selInfo.info.isInComment&&this.app.isCommentDisabledInRestrictEditMode())&&(this.app.isReadOnlyComment()||!this.app.isReadOnly())):!this.app.isReadOnly()&&o}},{key:"makeCommentAreaVisible",value:function(e,t){var n=window.APP.workspace;n.makeContentVisible(e,{isRefocusComment:t,isTimeLimited:!1,adjustWhenInvisible:!0,diffY:n.element.cacheDOMAttr.clientHeight/3,diffX:n.element.cacheDOMAttr.clientWidth/3})}},{key:"isReEditComment",get:function(){return this.dataHandler.reEditCommentId&&this.dataHandler.reEditCommentId===this.dataHandler.tempCommentId}},{key:"isRevisionVisible",get:function(){return!this.app.isCooperationMode&&!window.__CONFIG__.wps.disableRevisionComment&&!this.app.coreDataInvalid()&&this.app.data.doc.viewSettings.isShowRevisionFrame()}},{key:"isCommentBubbleStatus",get:function(){return this.app.commentShowStatus.commentBubble||this.revisionVisibleStatus}}]),t}(b.a)},1131:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPraiseEmoji=t.getEmojiById=t.getEmojiListOrder=t.idToEmoji=t.emojiMap=void 0;var i=n(5);t.emojiMap=[{id:"001",name:_i18n("applications.writer.helpers.emojiController.emoji.praise", "Like"),value:"praise",unicode:""},{id:"002",name:_i18n("applications.writer.helpers.emojiController.emoji.ok", "OK"),value:"ok",unicode:""},{id:"003",name:_i18n("applications.writer.helpers.emojiController.emoji.rose", "flowers"),value:"rose",unicode:""},{id:"004",name:_i18n("applications.writer.helpers.emojiController.emoji.hug_fist", "Fist"),value:"hug_fist",unicode:""},{id:"005",name:_i18n("applications.writer.helpers.emojiController.emoji.congratulate", "celebrate"),value:"congratulate",unicode:""}];t.idToEmoji=function(){return t.emojiMap.reduce((function(e,t){var n=t.id,i=t.name,a=t.value;return e[n]={name:i,value:a},e}),{})};t.getEmojiListOrder=function(){return t.emojiMap.map((function(e){return e.id}))};t.getEmojiById=function(e){if(!e)return null;var n=t.emojiMap.find((function(t){return t.id===e}));return n?i.__assign({},n):null};t.getPraiseEmoji=function(){var e=t.emojiMap.find((function(e){return"praise"===e.value}));return e?i.__assign({},e):null}},12967:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.commentComponentInfoList=[]}return e.prototype.onCommentComponentMounted=function(e){var t=this.getIndex(e);-1!==t&&this.commentComponentInfoList.splice(t,1),this.commentComponentInfoList.push(e)},e.prototype.onCommentComponentUnMounted=function(e){var t=this.getIndex(e);-1!==t&&this.commentComponentInfoList.splice(t,1)},e.prototype.getCommentComponentInfo=function(e){if(!e.rcId&&!e.commentId)return null;var t=this.getIndex(e);return-1!==t?this.commentComponentInfoList[t]:null},e.prototype.getIndex=function(e){return this.commentComponentInfoList.findIndex((function(t){var n=t.rcId&&t.rcId===e.rcId,i=t.commentId&&t.commentId===e.commentId,a=!e.source||e.source===t.source;return(n||i)&&a}))},e}();t.default=i},1380:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitFontProperty=t.getRealFontName=t.changeFontNameInText=t.getFontNameToDisplay=void 0;var i=n(167),a=new Map;function o(e){if(window.__CONFIG__.useSansZh&&!i.isWindows){var t=e.replace(//g,"");return t=t.replace(/Microsoft YaHei/g,"YaHei")}return e}t.getFontNameToDisplay=function(e){var t=o(e);return t!==e&&a.set(t,e),t},t.changeFontNameInText=function(e){return o(e)},t.getRealFontName=function(e){return a.has(e)?a.get(e):e},t.splitFontProperty=function(e){var t=document.createElement("text");if(t.style.font=e,!t.style.font)return null;var n=t.style,i=n.fontSize,a=n.fontFamily,o=n.fontStyle,s=n.fontVariant,r=n.fontWeight,d=n.lineHeight;return{fontSize:parseInt(i),fontFamily:a,fontStyle:o,fontVariant:s,fontWeight:r,lineHeight:d}}},4721:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkHasCommentPermission=t.goToApplyForPermission=void 0;var i=n(343),a=n(486);t.goToApplyForPermission=function(){window.__CONFIG__.isShowNoPermissionComponent?!(window.fileInfo&&window.fileInfo.user_acl||{}).update&&i.canGotoEdit?(0,i.gotoEdit)({hidesave:!0}):a.canRequestForAuthForSecurityDoc&&(0,a.isEditLimitedSecurityDoc)()&&(0,a.requestForAuth)({type:a.AUTH_TYPES.EDIT}):window.Toast.info(_i18n("applications.writer.components.mobile.Other.CommentPanel.readOnly", "The document is read-only"))},t.checkHasCommentPermission=function(){return window.APP.functionStatus.comment.hasCommentAuthority?Promise.resolve():Promise.reject()}},486:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canRequestForAuthForSecurityDoc=t.requestForAuth=t.isPrintLimitedSecurityDoc=t.isCopyLimitedSecurityDoc=t.isEditLimitedSecurityDoc=t.isSupportSecurityDoc=t.AUTH_TYPES=void 0;var i=n(5).__importDefault(n(82)),a={EDIT:"edit",COPY:"copy",PRINT:"print",SAVE_AS:"saveAs"};t.AUTH_TYPES=a;var o={pluginType:window.__WPSPLUGIN__.helper.types.SecureDocApplyAuth};var s=[i.default.writer,i.default.spreadsheet,i.default.presentation].includes(window.officeType);function r(){return window.APP.getSecurityDocPermission()||{}}function d(){return 1===r().doctype}t.isSupportSecurityDoc=s,t.isEditLimitedSecurityDoc=function(){return d()&&!(!0===r().edit)},t.isCopyLimitedSecurityDoc=function(){return d()&&!(!0===r().copy)},t.isPrintLimitedSecurityDoc=function(){return d()&&!(!0===r().print)},t.requestForAuth=function(e){return void 0===e&&(e={type:a.EDIT}),window.__WPSPLUGIN__.loader.loadSingleInstance(o).then((function(t){return t.show(e.type)}))};var m=s&&!!window.__WPSPLUGIN__.loader.search(o);t.canRequestForAuthForSecurityDoc=m},564:function(e,t,n){"use strict";var i,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.getEditModeQueryPair=t.isNewFile=t.isEditEnterMode=t.closeReadingMode=t.isReadingMode=void 0;var s=n(5).__importStar(n(167)),r=n(14),d=!!(null===(o=null===(a=null===(i=window.__WPSENV__)||void 0===i?void 0:i.file_info)||void 0===a?void 0:a.file)||void 0===o?void 0:o.corp_id),m=s.isMobile;t.isReadingMode=function(){var e,t,n;return(null===(t=null===(e=window.APP)||void 0===e?void 0:e.isReadOnly)||void 0===t?void 0:t.call(e))&&"read"===(null===(n=window.__WPSENV__)||void 0===n?void 0:n.enterMode)&&d&&!m},t.closeReadingMode=function(){(0,r.setQuery)("enterMode","edit"),location.reload()},t.isEditEnterMode=function(){return"edit"===(0,r.getQuery)("enterMode")},t.isNewFile=function(){return"true"===(0,r.getQuery)("newFile")},t.getEditModeQueryPair=function(){return{enterMode:"edit"}}}}]);